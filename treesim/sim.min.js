!function(){const t=document.getElementById("simCanvas"),e=t.getContext("2d"),n={speed:.5,branchChance:.02,branchAngle:18,wiggle:.1,gravity:0,phototropismStrength:.015,sunX:.5,sunY:20,taper:.95,initialWidth:12,minWidth:.5,segmentLength:5,seed:null,stopOnCollision:!1,collisionGraceSteps:3,leafLength:20,leafWidth:8,leafColor:"#64c864",leafAngleVariance:.4},l={speed:document.getElementById("speed"),chance:document.getElementById("chance"),angle:document.getElementById("angle"),wiggle:document.getElementById("wiggle"),initialWidth:document.getElementById("initial-width"),gravity:document.getElementById("gravity"),taper:document.getElementById("taper"),segmentLength:document.getElementById("segment-length"),seedInput:document.getElementById("seed"),seedLabel:document.getElementById("seed-label"),seedBtn:document.getElementById("seed-btn"),regenerateBtn:document.getElementById("btn-regenerate"),stopOnCollision:document.getElementById("stop-on-collision"),valStopCollision:document.getElementById("val-stop-collision"),btnStart:document.getElementById("btn-start"),btnReset:document.getElementById("btn-reset"),valSpeed:document.getElementById("val-speed"),valChance:document.getElementById("val-chance"),valAngle:document.getElementById("val-angle"),valWiggle:document.getElementById("val-wiggle"),valInitialWidth:document.getElementById("val-initial-width"),valGravity:document.getElementById("val-gravity"),phototropism:document.getElementById("phototropism"),valPhototropism:document.getElementById("val-phototropism"),sunX:document.getElementById("sun-x"),valSunX:document.getElementById("val-sun-x"),valTaper:document.getElementById("val-taper"),valSegmentLength:document.getElementById("val-segment-length"),collisionGrace:document.getElementById("collision-grace"),valCollisionGrace:document.getElementById("val-collision-grace"),btnCreateLeaves:document.getElementById("btn-create-leaves"),btnClearLeaves:document.getElementById("btn-clear-leaves"),leafSize:document.getElementById("leaf-size"),valLeafSize:document.getElementById("val-leaf-size"),leafWidth:document.getElementById("leaf-width"),valLeafWidth:document.getElementById("val-leaf-width"),leafColor:document.getElementById("leaf-color"),valLeafColor:document.getElementById("val-leaf-color"),statSegments:document.getElementById("segment-count"),statTips:document.getElementById("tip-count"),statLeaves:document.getElementById("leaf-count"),preset1:document.getElementById("preset-1"),preset2:document.getElementById("preset-2"),preset3:document.getElementById("preset-3"),preset4:document.getElementById("preset-4")};let a=[],o=[],i=!0,s=null,r=0,h=null;class c{constructor(t,e,n,l,a){this.x=t,this.y=e,this.angle=n,this.width=l,this.parentIndex=a,this.drawn=!1,this.leaf=null}}class g{constructor(t,e,n,l,a,o=0){this.x=t,this.y=e,this.angle=n,this.width=l,this.parentIndex=a,this.age=o}}function d(t){for(;t<=-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;return t}let p=Math.random;function u(t){if(null===t||""===t)n.seed=null,p=Math.random,l.seedLabel&&(l.seedLabel.textContent="—");else{const e=Number(t)||0;n.seed=e,p=function(t){let e=t>>>0;return function(){e+=1831565813;let t=Math.imul(e^e>>>15,1|e);return t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}(e),h=e,l.seedLabel&&(l.seedLabel.textContent=String(e))}}function m(n,l,o=-1){if(!a||0===a.length)return!1;const i=Math.floor(n),s=Math.floor(l);if(i<0||s<0||i>=t.width||s>=t.height)return!1;let r=-1,h=-1,c=-1;if(o>=0&&(r=o,a[o]&&a[o].parentIndex>=0)){h=a[o].parentIndex;const t=a[h]&&a[h].parentIndex;"number"==typeof t&&t>=0&&(c=t)}try{const t=e.getImageData(i,s,1,1).data,g=t[0],d=t[1],p=t[2];if(0!==t[3]&&(26!==g||26!==d||26!==p)){let t=-1,e=Number.POSITIVE_INFINITY,i=null;for(let o=0;o<a.length;o++){if(o===r||o===h||o===c)continue;const s=a[o];if(-1===s.parentIndex)continue;const g=a[s.parentIndex],d=s.x-g.x,p=s.y-g.y,u=d*d+p*p;if(u<=0)continue;let m=((n-g.x)*d+(l-g.y)*p)/u;m=Math.max(0,Math.min(1,m));const v=g.x+m*d,f=g.y+m*p,C=v-n,y=f-l,I=C*C+y*y;I<e&&(e=I,t=o,i=s)}if(i){const n=.6*Math.max(1,i.width/2)+.25;if(e<=(n+.5)*(n+.5)){if(t!==o)return!0}}}}catch(t){}for(let t=0;t<a.length;t++){if(t===r||t===h||t===c)continue;const e=a[t];if(-1===e.parentIndex)continue;const o=a[e.parentIndex],i=o.x,s=o.y,g=e.x-i,d=e.y-s,p=g*g+d*d;let u=0;p>0&&(u=((n-i)*g+(l-s)*d)/p,u=Math.max(0,Math.min(1,u)));const m=i+u*g-n,v=s+u*d-l,f=m*m+v*v,C=Math.max(1,e.width/2);if(f<=(C+1)*(C+1))return!0}return!1}function v(){t.width=window.innerWidth,t.height=window.innerHeight,!i&&a.length>0&&C()}function f(){if(null===n.seed&&null===h){const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,u(t)}else null===n.seed&&null!==h?u(h):null!==n.seed&&u(n.seed);a=[],o=[],r=0;const i=t.width/2,s=t.height;o.push(new g(i,s,-Math.PI/2,n.initialWidth,-1)),e.fillStyle="#1a1a1a",e.fillRect(0,0,t.width,t.height),I()}function C(){e.fillStyle="#1a1a1a",e.fillRect(0,0,t.width,t.height),e.lineCap="round",e.lineJoin="round";for(let t=0;t<a.length;t++){const n=a[t];if(-1===n.parentIndex)continue;const l=a[n.parentIndex],o=n.width,i=Math.max(30,Math.min(70,70-3*o));if(e.strokeStyle=`hsl(32, 60%, ${i}%)`,e.lineWidth=o,e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(n.x,n.y),e.stroke(),n.leaf){const t=n.leaf,l=n.angle+(t.angleOffset||0);y(e,n.x,n.y,l,t.length,t.width,t.color)}}!function(t,e,n){const l=12,a=t.createRadialGradient(e,n,.2*l,e,n,l);a.addColorStop(0,"rgba(255,245,120,0.95)"),a.addColorStop(1,"rgba(255,200,30,0.6)"),t.beginPath(),t.fillStyle=a,t.arc(e,n,l,0,2*Math.PI),t.fill(),t.beginPath(),t.fillStyle="rgba(255,235,120,0.06)",t.arc(e,n,l+8,0,2*Math.PI),t.fill(),t.lineWidth=1,t.strokeStyle="rgba(255,255,255,0.15)",t.beginPath(),t.arc(e,n,l,0,2*Math.PI),t.stroke()}(e,n.sunX*t.width,n.sunY)}function y(t,e,n,l,a,o,i){const s=e+Math.cos(l)*a,r=n+Math.sin(l)*a,h=(e+s)/2,c=(n+r)/2,g=l-Math.PI/2,d=h+Math.cos(g)*o,p=c+Math.sin(g)*o,u=h+Math.cos(g+Math.PI)*o,m=c+Math.sin(g+Math.PI)*o;t.beginPath(),t.moveTo(e,n),t.quadraticCurveTo(d,p,s,r),t.quadraticCurveTo(u,m,e,n),t.fillStyle=i||"rgba(100,200,100,0.85)",t.fill(),t.strokeStyle="rgba(0,0,0,0.25)",t.lineWidth=Math.max(1,.15*o),t.beginPath(),t.moveTo(e,n),t.lineTo(s,r),t.stroke()}function I(){l.statSegments.textContent=a.length,l.statTips.textContent=o.length,l.statLeaves&&(l.statLeaves.textContent=a.reduce((t,e)=>e.leaf?t+1:t,0))}const x={speed:"speed",branchChance:"chance",branchAngle:"angle",wiggle:"wiggle",gravity:"gravity",phototropismStrength:"phototropism",sunX:"sunX",initialWidth:"initialWidth",taper:"taper",segmentLength:"segmentLength",collisionGraceSteps:"collisionGrace",stopOnCollision:"stopOnCollision",leafLength:"leafSize",leafWidth:"leafWidth"};function S(t){for(const e in t){if(!t.hasOwnProperty(e))continue;n[e]=t[e];const a=x[e]||e;if(l[a])try{l[a].value=t[e]}catch(t){}"speed"===e&&l.valSpeed&&(l.valSpeed.textContent=n.speed),"branchChance"===e&&l.valChance&&(l.valChance.textContent=n.branchChance),"branchAngle"===e&&l.valAngle&&(l.valAngle.textContent=n.branchAngle),"wiggle"===e&&l.valWiggle&&(l.valWiggle.textContent=n.wiggle),"gravity"===e&&l.valGravity&&(l.valGravity.textContent=n.gravity),"phototropismStrength"===e&&l.valPhototropism&&(l.valPhototropism.textContent=n.phototropismStrength.toFixed(3)),"sunX"===e&&l.valSunX&&(l.valSunX.textContent=n.sunX.toFixed(2)),"initialWidth"===e&&l.valInitialWidth&&(l.valInitialWidth.textContent=n.initialWidth),"taper"===e&&l.valTaper&&(l.valTaper.textContent=n.taper),"segmentLength"===e&&l.valSegmentLength&&(l.valSegmentLength.textContent=n.segmentLength),"collisionGraceSteps"===e&&l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps),"stopOnCollision"===e&&l.stopOnCollision&&(l.stopOnCollision.checked=!!n.stopOnCollision),"stopOnCollision"===e&&l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off"),"leafLength"===e&&l.valLeafSize&&(l.valLeafSize.textContent=n.leafLength),"leafWidth"===e&&l.valLeafWidth&&(l.valLeafWidth.textContent=n.leafWidth)}f(),i||C()}function b(){const t=function(){const t=new Array(a.length).fill(!1);for(let e=0;e<a.length;e++){const n=a[e].parentIndex;n>=0&&n<a.length&&(t[n]=!0)}const e=[];for(let n=0;n<a.length;n++)-1!==a[n].parentIndex&&(t[n]||e.push(n));return e}();for(let e of t){const t=a[e],l=n.leafLength+(p()-.5)*n.leafLength*.2,o=Math.max(1,Math.round(n.leafWidth+2*(p()-.5))),i=n.leafColor,s=2*(p()-.5)*n.leafAngleVariance;t.leaf={length:l,width:o,color:i,angleOffset:s}}}l.speed.oninput=t=>{n.speed=parseFloat(t.target.value),l.valSpeed&&(l.valSpeed.textContent=n.speed)},l.chance.oninput=t=>{n.branchChance=parseFloat(t.target.value),l.valChance&&(l.valChance.textContent=n.branchChance)},l.angle.oninput=t=>{n.branchAngle=parseInt(t.target.value),l.valAngle&&(l.valAngle.textContent=n.branchAngle)},l.wiggle.oninput=t=>{n.wiggle=parseFloat(t.target.value),l.valWiggle&&(l.valWiggle.textContent=n.wiggle)},l.initialWidth.oninput=t=>{n.initialWidth=parseInt(t.target.value),l.valInitialWidth&&(l.valInitialWidth.textContent=n.initialWidth)},l.gravity.oninput=t=>{n.gravity=parseFloat(t.target.value),l.valGravity&&(l.valGravity.textContent=n.gravity)},l.taper.oninput=t=>{n.taper=parseFloat(t.target.value),l.valTaper&&(l.valTaper.textContent=n.taper)},l.segmentLength.oninput=t=>{n.segmentLength=parseInt(t.target.value),l.valSegmentLength&&(l.valSegmentLength.textContent=n.segmentLength)},l.seedBtn.onclick=()=>{const t=l.seedInput.value;u(""===t?null:Number(t)),f()},l.stopOnCollision.checked=!!n.stopOnCollision,l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off");const L=t=>{n.stopOnCollision=!!t,l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off")};l.stopOnCollision.addEventListener("input",t=>L(t.target.checked)),l.stopOnCollision.addEventListener("change",t=>L(t.target.checked)),l.collisionGrace.value=n.collisionGraceSteps,l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps),l.collisionGrace.oninput=t=>{n.collisionGraceSteps=parseInt(t.target.value||0),l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps)},l.phototropism.value=n.phototropismStrength,l.valPhototropism&&(l.valPhototropism.textContent=n.phototropismStrength.toFixed(3)),l.phototropism.oninput=t=>{n.phototropismStrength=parseFloat(t.target.value),l.valPhototropism&&(l.valPhototropism.textContent=n.phototropismStrength.toFixed(3))},l.sunX.value=n.sunX,l.valSunX&&(l.valSunX.textContent=n.sunX.toFixed(2)),l.sunX.oninput=t=>{n.sunX=parseFloat(t.target.value),l.valSunX&&(l.valSunX.textContent=n.sunX.toFixed(2))},l.preset1.onclick=()=>S({speed:.5,branchChance:.035,branchAngle:22,wiggle:.05,gravity:0,phototropismStrength:.015,sunX:.5,initialWidth:8,taper:.94,segmentLength:4,collisionGraceSteps:2,stopOnCollision:!1,leafLength:12,leafWidth:5}),l.preset2.onclick=()=>S({speed:.6,branchChance:.008,branchAngle:12,wiggle:.02,gravity:0,phototropismStrength:.03,sunX:.5,initialWidth:25,taper:.8,segmentLength:7,collisionGraceSteps:8,stopOnCollision:!1,leafLength:10,leafWidth:4}),l.preset3.onclick=()=>S({speed:.5,branchChance:.025,branchAngle:10,wiggle:.06,gravity:.02,phototropismStrength:.01,sunX:.4,initialWidth:14,taper:.95,segmentLength:5,collisionGraceSteps:5,stopOnCollision:!1,leafLength:14,leafWidth:6}),l.preset4.onclick=()=>S({speed:.5,branchChance:.015,branchAngle:90,wiggle:.01,gravity:0,phototropismStrength:0,sunX:.5,initialWidth:5,taper:1,segmentLength:4,collisionGraceSteps:3,stopOnCollision:!0,leafLength:1,leafWidth:1}),l.leafSize.value=n.leafLength,l.valLeafSize.textContent=n.leafLength,l.leafSize.oninput=t=>{n.leafLength=parseInt(t.target.value),l.valLeafSize&&(l.valLeafSize.textContent=n.leafLength)},l.leafWidth.value=n.leafWidth,l.valLeafWidth.textContent=n.leafWidth,l.leafWidth.oninput=t=>{n.leafWidth=parseInt(t.target.value),l.valLeafWidth&&(l.valLeafWidth.textContent=n.leafWidth)},l.leafColor.value=n.leafColor,l.valLeafColor.textContent=n.leafColor,l.leafColor.oninput=t=>{n.leafColor=t.target.value,l.valLeafColor&&(l.valLeafColor.textContent=n.leafColor)},l.btnCreateLeaves.onclick=()=>{b(),i||C()},l.btnClearLeaves.onclick=()=>{!function(){for(let t=0;t<a.length;t++)a[t].leaf=null}(),i||C()},l.btnStart.onclick=()=>{i=!i,i?(l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300"):(l.btnStart.textContent="▶",l.btnStart.title="Play",l.btnStart.style.backgroundColor="#fbbf24",l.btnStart.style.color="#000")},l.btnReset.onclick=()=>{const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,u(t),f(),i||C()},l.regenerateBtn.onclick=()=>{if(null!==n.seed)u(n.seed);else if(null!==h)u(h),l.seedInput.value=h;else{const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,u(t)}f(),i||C()},window.addEventListener("resize",v),v(),u(null),f(),l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300",l.btnReset.textContent="Generate new",function e(){i&&(!function(){if(i){for(r+=n.speed;r>=1&&(r-=1,0!==o.length);){let e=[];const l=n.segmentLength,i=n.wiggle,s=n.gravity,r=(n.branchChance,n.branchAngle*Math.PI/180),h=(n.taper,.999),u=n.minWidth,v=!!n.stopOnCollision,f=(n.collisionGraceSteps,t.width),C=t.height;for(let t=0;t<o.length;t++){const y=o[t];if(y.width<u||y.x<-50||y.x>f+50||y.y<-50||y.y>C+50)continue;const I=(p()-.5)*i,x=p(),S=s;let b=y.angle+I+S;const L=n.phototropismStrength||0;if(L>0){const t=("number"==typeof n.sunX?n.sunX:.5)*f,e=n.sunY||0,l=Math.atan2(e-y.y,t-y.x),a=Math.min(1,y.y/C);b+=L*d(l-b)*a}const w=y.x+Math.cos(b)*l,W=y.y+Math.sin(b)*l;y.age++;const B=n.collisionGraceSteps||0;if(v&&y.age>=B&&m(w,W,y.parentIndex))continue;const E=a.length;if(a.push(new c(w,W,b,y.width,y.parentIndex)),x<n.branchChance){const t=r;e.push(new g(w,W,b-t,y.width*n.taper,E,0)),e.push(new g(w,W,b+t,y.width*n.taper,E,0))}else e.push(new g(w,W,b,y.width*h,E,y.age))}o=e}I()}}(),C()),s=requestAnimationFrame(e)}()}();