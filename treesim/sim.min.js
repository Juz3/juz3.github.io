!function(){const t=document.getElementById("simCanvas"),e=t.getContext("2d"),n={speed:.5,branchChance:.02,branchAngle:18,wiggle:.1,gravity:0,taper:.95,initialWidth:12,minWidth:.5,segmentLength:5,seed:null,stopOnCollision:!1,collisionGraceSteps:3},l={speed:document.getElementById("speed"),chance:document.getElementById("chance"),angle:document.getElementById("angle"),wiggle:document.getElementById("wiggle"),gravity:document.getElementById("gravity"),taper:document.getElementById("taper"),segmentLength:document.getElementById("segment-length"),seedInput:document.getElementById("seed"),seedLabel:document.getElementById("seed-label"),seedBtn:document.getElementById("seed-btn"),regenerateBtn:document.getElementById("btn-regenerate"),stopOnCollision:document.getElementById("stop-on-collision"),valStopCollision:document.getElementById("val-stop-collision"),btnStart:document.getElementById("btn-start"),btnReset:document.getElementById("btn-reset"),valSpeed:document.getElementById("val-speed"),valChance:document.getElementById("val-chance"),valAngle:document.getElementById("val-angle"),valWiggle:document.getElementById("val-wiggle"),valGravity:document.getElementById("val-gravity"),valTaper:document.getElementById("val-taper"),valSegmentLength:document.getElementById("val-segment-length"),collisionGrace:document.getElementById("collision-grace"),valCollisionGrace:document.getElementById("val-collision-grace"),statSegments:document.getElementById("segment-count"),statTips:document.getElementById("tip-count")};let o=[],a=[],i=!0,s=null,r=0,c=null;class d{constructor(t,e,n,l,o){this.x=t,this.y=e,this.angle=n,this.width=l,this.parentIndex=o,this.drawn=!1}}class g{constructor(t,e,n,l,o,a=0){this.x=t,this.y=e,this.angle=n,this.width=l,this.parentIndex=o,this.age=a}}let h=Math.random;function u(t){if(null===t||""===t)n.seed=null,h=Math.random,l.seedLabel&&(l.seedLabel.textContent="—");else{const e=Number(t)||0;n.seed=e,h=function(t){let e=t>>>0;return function(){e+=1831565813;let t=Math.imul(e^e>>>15,1|e);return t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}(e),c=e,l.seedLabel&&(l.seedLabel.textContent=String(e))}}function p(n,l,a=-1){if(!o||0===o.length)return!1;const i=Math.floor(n),s=Math.floor(l);if(i<0||s<0||i>=t.width||s>=t.height)return!1;let r=-1,c=-1,d=-1;if(a>=0&&(r=a,o[a]&&o[a].parentIndex>=0)){c=o[a].parentIndex;const t=o[c]&&o[c].parentIndex;"number"==typeof t&&t>=0&&(d=t)}try{const t=e.getImageData(i,s,1,1).data,g=t[0],h=t[1],u=t[2];if(0!==t[3]&&(26!==g||26!==h||26!==u)){let t=-1,e=Number.POSITIVE_INFINITY,i=null;for(let a=0;a<o.length;a++){if(a===r||a===c||a===d)continue;const s=o[a];if(-1===s.parentIndex)continue;const g=o[s.parentIndex],h=s.x-g.x,u=s.y-g.y,p=h*h+u*u;if(p<=0)continue;let m=((n-g.x)*h+(l-g.y)*u)/p;m=Math.max(0,Math.min(1,m));const v=g.x+m*h,y=g.y+m*u,I=v-n,f=y-l,C=I*I+f*f;C<e&&(e=C,t=a,i=s)}if(i){const n=.6*Math.max(1,i.width/2)+.25;if(e<=(n+.5)*(n+.5)){if(t!==a)return!0}}}}catch(t){}for(let t=0;t<o.length;t++){if(t===r||t===c||t===d)continue;const e=o[t];if(-1===e.parentIndex)continue;const a=o[e.parentIndex],i=a.x,s=a.y,g=e.x-i,h=e.y-s,u=g*g+h*h;let p=0;u>0&&(p=((n-i)*g+(l-s)*h)/u,p=Math.max(0,Math.min(1,p)));const m=i+p*g-n,v=s+p*h-l,y=m*m+v*v,I=Math.max(1,e.width/2);if(y<=(I+1)*(I+1))return!0}return!1}function m(){t.width=window.innerWidth,t.height=window.innerHeight,!i&&o.length>0&&y()}function v(){if(null===n.seed&&null===c){const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,u(t)}else null===n.seed&&null!==c?u(c):null!==n.seed&&u(n.seed);o=[],a=[],r=0;const i=t.width/2,s=t.height;a.push(new g(i,s,-Math.PI/2,n.initialWidth,-1)),e.fillStyle="#1a1a1a",e.fillRect(0,0,t.width,t.height),I()}function y(){e.fillStyle="#1a1a1a",e.fillRect(0,0,t.width,t.height),e.lineCap="round",e.lineJoin="round";for(let t=0;t<o.length;t++){const n=o[t];if(-1===n.parentIndex)continue;const l=o[n.parentIndex],a=n.width,i=Math.max(30,Math.min(70,70-3*a));e.strokeStyle=`hsl(32, 60%, ${i}%)`,e.lineWidth=a,e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(n.x,n.y),e.stroke()}}function I(){l.statSegments.textContent=o.length,l.statTips.textContent=a.length}if(l.speed.oninput=t=>{n.speed=parseFloat(t.target.value),l.valSpeed.textContent=n.speed},l.chance.oninput=t=>{n.branchChance=parseFloat(t.target.value),l.valChance.textContent=n.branchChance},l.angle.oninput=t=>{n.branchAngle=parseInt(t.target.value),l.valAngle.textContent=n.branchAngle},l.wiggle.oninput=t=>{n.wiggle=parseFloat(t.target.value),l.valWiggle.textContent=n.wiggle},l.gravity.oninput=t=>{n.gravity=parseFloat(t.target.value),l.valGravity.textContent=n.gravity},l.taper.oninput=t=>{n.taper=parseFloat(t.target.value),l.valTaper.textContent=n.taper},l.segmentLength.oninput=t=>{n.segmentLength=parseInt(t.target.value),l.valSegmentLength.textContent=n.segmentLength},l.seedBtn.onclick=()=>{const t=l.seedInput.value;u(""===t?null:Number(t)),v()},l.stopOnCollision){l.stopOnCollision.checked=!!n.stopOnCollision,l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off");const t=t=>{n.stopOnCollision=!!t,l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off")};l.stopOnCollision.addEventListener("input",e=>t(e.target.checked)),l.stopOnCollision.addEventListener("change",e=>t(e.target.checked))}l.collisionGrace&&(l.collisionGrace.value=n.collisionGraceSteps,l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps),l.collisionGrace.oninput=t=>{n.collisionGraceSteps=parseInt(t.target.value||0),l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps)}),l.btnStart.onclick=()=>{i=!i,i?(l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300"):(l.btnStart.textContent="▶",l.btnStart.title="Play",l.btnStart.style.backgroundColor="#fbbf24",l.btnStart.style.color="#000")},l.btnReset.onclick=()=>{const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,u(t),v(),i||y()},l.regenerateBtn.onclick=()=>{if(null!==n.seed)u(n.seed);else if(null!==c)u(c),l.seedInput.value=c;else{const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,u(t)}v(),i||y()},window.addEventListener("resize",m),m(),u(null),v(),l.btnStart&&(l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300"),l.btnReset&&(l.btnReset.textContent="Generate new"),function e(){i&&(!function(){if(i){for(r+=n.speed;r>=1&&(r-=1,0!==a.length);){let e=[];const l=n.segmentLength,i=n.wiggle,s=n.gravity,r=(n.branchChance,n.branchAngle*Math.PI/180),c=(n.taper,.999),u=n.minWidth,m=!!n.stopOnCollision,v=(n.collisionGraceSteps,t.width),y=t.height;for(let t=0;t<a.length;t++){const I=a[t];if(I.width<u||I.x<-50||I.x>v+50||I.y<-50||I.y>y+50)continue;const f=(h()-.5)*i,C=h(),x=s;let b=I.angle+f+x;const S=I.x+Math.cos(b)*l,w=I.y+Math.sin(b)*l;I.age++;const B=n.collisionGraceSteps||0;if(m&&I.age>=B&&p(S,w,I.parentIndex))continue;const E=o.length;if(o.push(new d(S,w,b,I.width,I.parentIndex)),C<n.branchChance){const t=r;e.push(new g(S,w,b-t,I.width*n.taper,E,0)),e.push(new g(S,w,b+t,I.width*n.taper,E,0))}else e.push(new g(S,w,b,I.width*c,E,I.age))}a=e}I()}}(),y()),s=requestAnimationFrame(e)}()}();