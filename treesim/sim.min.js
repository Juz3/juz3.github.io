!function(){const t=document.getElementById("simCanvas"),e=t.getContext("2d"),n={speed:1,branchChance:.02,branchAngle:22,wiggle:.15,gravity:0,phototropismStrength:.015,sunX:.5,sunY:20,taper:.85,initialWidth:25,minWidth:.5,segmentLength:5,seed:null,stopOnCollision:!1,collisionGraceSteps:3,leafLength:20,leafWidth:8,leafColor:"#64c864",leafAngleVariance:.4,trunkColor:"#a66e2b",maxTipAge:200,maxActiveTips:200},a={speed:document.getElementById("speed"),chance:document.getElementById("chance"),angle:document.getElementById("angle"),wiggle:document.getElementById("wiggle"),initialWidth:document.getElementById("initial-width"),gravity:document.getElementById("gravity"),taper:document.getElementById("taper"),segmentLength:document.getElementById("segment-length"),seedInput:document.getElementById("seed"),seedLabel:document.getElementById("seed-label"),seedBtn:document.getElementById("seed-btn"),regenerateBtn:document.getElementById("btn-regenerate"),stopOnCollision:document.getElementById("stop-on-collision"),valStopCollision:document.getElementById("val-stop-collision"),btnStart:document.getElementById("btn-start"),btnReset:document.getElementById("btn-reset"),valSpeed:document.getElementById("val-speed"),valChance:document.getElementById("val-chance"),valAngle:document.getElementById("val-angle"),valWiggle:document.getElementById("val-wiggle"),valInitialWidth:document.getElementById("val-initial-width"),valGravity:document.getElementById("val-gravity"),phototropism:document.getElementById("phototropism"),valPhototropism:document.getElementById("val-phototropism"),sunX:document.getElementById("sun-x"),valSunX:document.getElementById("val-sun-x"),valTaper:document.getElementById("val-taper"),valSegmentLength:document.getElementById("val-segment-length"),collisionGrace:document.getElementById("collision-grace"),valCollisionGrace:document.getElementById("val-collision-grace"),btnCreateLeaves:document.getElementById("btn-create-leaves"),btnClearLeaves:document.getElementById("btn-clear-leaves"),leafSize:document.getElementById("leaf-size"),valLeafSize:document.getElementById("val-leaf-size"),leafWidth:document.getElementById("leaf-width"),valLeafWidth:document.getElementById("val-leaf-width"),leafColor:document.getElementById("leaf-color"),valLeafColor:document.getElementById("val-leaf-color"),statSegments:document.getElementById("segment-count"),statTips:document.getElementById("tip-count"),statLeaves:document.getElementById("leaf-count"),trunkColor:document.getElementById("trunk-color"),valTrunkColor:document.getElementById("val-trunk-color"),maxTipAge:document.getElementById("max-tip-age"),valMaxTipAge:document.getElementById("val-max-tip-age"),maxActiveTips:document.getElementById("max-active-tips"),valMaxActiveTips:document.getElementById("val-max-active-tips"),preset1:document.getElementById("preset-1"),preset2:document.getElementById("preset-2"),preset3:document.getElementById("preset-3"),preset4:document.getElementById("preset-4")};let l=[],o=[],i=!0,r=null,s=0,c=null;class g{constructor(t,e,n,a,l){this.x=t,this.y=e,this.angle=n,this.width=a,this.parentIndex=l,this.drawn=!1,this.leaf=null}}class h{constructor(t,e,n,a,l,o=0){this.x=t,this.y=e,this.angle=n,this.width=a,this.parentIndex=l,this.age=o}}function d(t){for(;t<=-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;return t}let p=Math.random;function u(t){if(null===t||""===t)n.seed=null,p=Math.random,a.seedLabel&&(a.seedLabel.textContent="—");else{const e=Number(t)||0;n.seed=e,p=function(t){let e=t>>>0;return function(){e+=1831565813;let t=Math.imul(e^e>>>15,1|e);return t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}(e),c=e,a.seedLabel&&(a.seedLabel.textContent=String(e))}}function m(n,a,o=-1){if(!l||0===l.length)return!1;const i=Math.floor(n),r=Math.floor(a);if(i<0||r<0||i>=t.width||r>=t.height)return!1;let s=-1,c=-1,g=-1;if(o>=0&&(s=o,l[o]&&l[o].parentIndex>=0)){c=l[o].parentIndex;const t=l[c]&&l[c].parentIndex;"number"==typeof t&&t>=0&&(g=t)}try{const t=e.getImageData(i,r,1,1).data,h=t[0],d=t[1],p=t[2];if(0!==t[3]&&(26!==h||26!==d||26!==p)){let t=-1,e=Number.POSITIVE_INFINITY,i=null;for(let o=0;o<l.length;o++){if(o===s||o===c||o===g)continue;const r=l[o];if(-1===r.parentIndex)continue;const h=l[r.parentIndex],d=r.x-h.x,p=r.y-h.y,u=d*d+p*p;if(u<=0)continue;let m=((n-h.x)*d+(a-h.y)*p)/u;m=Math.max(0,Math.min(1,m));const v=h.x+m*d,f=h.y+m*p,C=v-n,x=f-a,y=C*C+x*x;y<e&&(e=y,t=o,i=r)}if(i){const n=.6*Math.max(1,i.width/2)+.25;if(e<=(n+.5)*(n+.5)){if(t!==o)return!0}}}}catch(t){}for(let t=0;t<l.length;t++){if(t===s||t===c||t===g)continue;const e=l[t];if(-1===e.parentIndex)continue;const o=l[e.parentIndex],i=o.x,r=o.y,h=e.x-i,d=e.y-r,p=h*h+d*d;let u=0;p>0&&(u=((n-i)*h+(a-r)*d)/p,u=Math.max(0,Math.min(1,u)));const m=i+u*h-n,v=r+u*d-a,f=m*m+v*v,C=Math.max(1,e.width/2);if(f<=(C+1)*(C+1))return!0}return!1}function v(){t.width=window.innerWidth,t.height=window.innerHeight,!i&&l.length>0&&C()}function f(){if(null===n.seed&&null===c){const t=Math.floor(2147483647*Math.random());a.seedInput.value=t,u(t)}else null===n.seed&&null!==c?u(c):null!==n.seed&&u(n.seed);l=[],o=[],s=0;const i=t.width/2,r=t.height;o.push(new h(i,r,-Math.PI/2,n.initialWidth,-1)),e.fillStyle="#1a1a1a",e.fillRect(0,0,t.width,t.height),y()}function C(){e.fillStyle="#1a1a1a",e.fillRect(0,0,t.width,t.height),e.lineCap="round",e.lineJoin="round";const{h:a,s:o}=function(t){let e,n,a;3===(t=t.replace(/^#/,"")).length?(e=parseInt(t[0]+t[0],16)/255,n=parseInt(t[1]+t[1],16)/255,a=parseInt(t[2]+t[2],16)/255):(e=parseInt(t.substring(0,2),16)/255,n=parseInt(t.substring(2,4),16)/255,a=parseInt(t.substring(4,6),16)/255);const l=Math.max(e,n,a),o=Math.min(e,n,a),i=l-o;let r=0,s=0,c=(l+o)/2;return 0!==i&&(s=c>.5?i/(2-l-o):i/(l+o),r=l===e?((n-a)/i+(n<a?6:0))/6:l===n?((a-e)/i+2)/6:((e-n)/i+4)/6),{h:Math.round(360*r),s:Math.round(100*s),l:Math.round(100*c)}}(n.trunkColor);for(let t=0;t<l.length;t++){const n=l[t];if(-1===n.parentIndex)continue;const i=l[n.parentIndex],r=n.width,s=Math.max(30,Math.min(70,70-3*r));if(e.strokeStyle=`hsl(${a}, ${o}%, ${s}%)`,e.lineWidth=r,e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(n.x,n.y),e.stroke(),n.leaf){const t=n.leaf,a=n.angle+(t.angleOffset||0);x(e,n.x,n.y,a,t.length,t.width,t.color)}}!function(t,e,n){const a=12,l=t.createRadialGradient(e,n,.2*a,e,n,a);l.addColorStop(0,"rgba(255,245,120,0.95)"),l.addColorStop(1,"rgba(255,200,30,0.6)"),t.beginPath(),t.fillStyle=l,t.arc(e,n,a,0,2*Math.PI),t.fill(),t.beginPath(),t.fillStyle="rgba(255,235,120,0.06)",t.arc(e,n,a+8,0,2*Math.PI),t.fill(),t.lineWidth=1,t.strokeStyle="rgba(255,255,255,0.15)",t.beginPath(),t.arc(e,n,a,0,2*Math.PI),t.stroke()}(e,n.sunX*t.width,n.sunY)}function x(t,e,n,a,l,o,i){const r=e+Math.cos(a)*l,s=n+Math.sin(a)*l,c=(e+r)/2,g=(n+s)/2,h=a-Math.PI/2,d=c+Math.cos(h)*o,p=g+Math.sin(h)*o,u=c+Math.cos(h+Math.PI)*o,m=g+Math.sin(h+Math.PI)*o;t.beginPath(),t.moveTo(e,n),t.quadraticCurveTo(d,p,r,s),t.quadraticCurveTo(u,m,e,n),t.fillStyle=i||"rgba(100,200,100,0.85)",t.fill(),t.strokeStyle="rgba(0,0,0,0.25)",t.lineWidth=Math.max(1,.15*o),t.beginPath(),t.moveTo(e,n),t.lineTo(r,s),t.stroke()}function y(){a.statSegments.textContent=l.length,a.statTips.textContent=o.length,a.statLeaves&&(a.statLeaves.textContent=l.reduce((t,e)=>e.leaf?t+1:t,0))}const I={speed:"speed",branchChance:"chance",branchAngle:"angle",wiggle:"wiggle",gravity:"gravity",phototropismStrength:"phototropism",sunX:"sunX",initialWidth:"initialWidth",taper:"taper",segmentLength:"segmentLength",collisionGraceSteps:"collisionGrace",stopOnCollision:"stopOnCollision",leafLength:"leafSize",leafWidth:"leafWidth",trunkColor:"trunkColor",maxTipAge:"maxTipAge",maxActiveTips:"maxActiveTips"};function S(t){for(const e in t){if(!t.hasOwnProperty(e))continue;n[e]=t[e];const l=I[e]||e;if(a[l])try{a[l].value=t[e]}catch(t){}"speed"===e&&a.valSpeed&&(a.valSpeed.textContent=n.speed),"branchChance"===e&&a.valChance&&(a.valChance.textContent=n.branchChance),"branchAngle"===e&&a.valAngle&&(a.valAngle.textContent=n.branchAngle),"wiggle"===e&&a.valWiggle&&(a.valWiggle.textContent=n.wiggle),"gravity"===e&&a.valGravity&&(a.valGravity.textContent=n.gravity),"phototropismStrength"===e&&a.valPhototropism&&(a.valPhototropism.textContent=n.phototropismStrength.toFixed(3)),"sunX"===e&&a.valSunX&&(a.valSunX.textContent=n.sunX.toFixed(2)),"initialWidth"===e&&a.valInitialWidth&&(a.valInitialWidth.textContent=n.initialWidth),"taper"===e&&a.valTaper&&(a.valTaper.textContent=n.taper),"segmentLength"===e&&a.valSegmentLength&&(a.valSegmentLength.textContent=n.segmentLength),"collisionGraceSteps"===e&&a.valCollisionGrace&&(a.valCollisionGrace.textContent=n.collisionGraceSteps),"stopOnCollision"===e&&a.stopOnCollision&&(a.stopOnCollision.checked=!!n.stopOnCollision),"stopOnCollision"===e&&a.valStopCollision&&(a.valStopCollision.textContent=n.stopOnCollision?"on":"off"),"leafLength"===e&&a.valLeafSize&&(a.valLeafSize.textContent=n.leafLength),"leafWidth"===e&&a.valLeafWidth&&(a.valLeafWidth.textContent=n.leafWidth),"trunkColor"===e&&a.valTrunkColor&&(a.valTrunkColor.textContent=n.trunkColor),"maxTipAge"===e&&a.valMaxTipAge&&(a.valMaxTipAge.textContent=n.maxTipAge),"maxActiveTips"===e&&a.valMaxActiveTips&&(a.valMaxActiveTips.textContent=n.maxActiveTips)}f(),i||C()}function b(){const t=function(){const t=new Array(l.length).fill(!1);for(let e=0;e<l.length;e++){const n=l[e].parentIndex;n>=0&&n<l.length&&(t[n]=!0)}const e=[];for(let n=0;n<l.length;n++)-1!==l[n].parentIndex&&(t[n]||e.push(n));return e}();for(let e of t){const t=l[e],a=n.leafLength+(p()-.5)*n.leafLength*.2,o=Math.max(1,Math.round(n.leafWidth+2*(p()-.5))),i=n.leafColor,r=2*(p()-.5)*n.leafAngleVariance;t.leaf={length:a,width:o,color:i,angleOffset:r}}}a.speed.oninput=t=>{n.speed=parseFloat(t.target.value),a.valSpeed&&(a.valSpeed.textContent=n.speed)},a.chance.oninput=t=>{n.branchChance=parseFloat(t.target.value),a.valChance&&(a.valChance.textContent=n.branchChance)},a.angle.oninput=t=>{n.branchAngle=parseInt(t.target.value),a.valAngle&&(a.valAngle.textContent=n.branchAngle)},a.wiggle.oninput=t=>{n.wiggle=parseFloat(t.target.value),a.valWiggle&&(a.valWiggle.textContent=n.wiggle)},a.initialWidth.oninput=t=>{n.initialWidth=parseInt(t.target.value),a.valInitialWidth&&(a.valInitialWidth.textContent=n.initialWidth)},a.gravity.oninput=t=>{n.gravity=parseFloat(t.target.value),a.valGravity&&(a.valGravity.textContent=n.gravity)},a.taper.oninput=t=>{n.taper=parseFloat(t.target.value),a.valTaper&&(a.valTaper.textContent=n.taper)},a.segmentLength.oninput=t=>{n.segmentLength=parseInt(t.target.value),a.valSegmentLength&&(a.valSegmentLength.textContent=n.segmentLength)},a.seedBtn.onclick=()=>{const t=a.seedInput.value;u(""===t?null:Number(t)),f()},a.stopOnCollision.checked=!!n.stopOnCollision,a.valStopCollision&&(a.valStopCollision.textContent=n.stopOnCollision?"on":"off");const T=t=>{n.stopOnCollision=!!t,a.valStopCollision&&(a.valStopCollision.textContent=n.stopOnCollision?"on":"off")};a.stopOnCollision.addEventListener("input",t=>T(t.target.checked)),a.stopOnCollision.addEventListener("change",t=>T(t.target.checked)),a.collisionGrace.value=n.collisionGraceSteps,a.valCollisionGrace&&(a.valCollisionGrace.textContent=n.collisionGraceSteps),a.collisionGrace.oninput=t=>{n.collisionGraceSteps=parseInt(t.target.value||0),a.valCollisionGrace&&(a.valCollisionGrace.textContent=n.collisionGraceSteps)},a.phototropism.value=n.phototropismStrength,a.valPhototropism&&(a.valPhototropism.textContent=n.phototropismStrength.toFixed(3)),a.phototropism.oninput=t=>{n.phototropismStrength=parseFloat(t.target.value),a.valPhototropism&&(a.valPhototropism.textContent=n.phototropismStrength.toFixed(3))},a.sunX.value=n.sunX,a.valSunX&&(a.valSunX.textContent=n.sunX.toFixed(2)),a.sunX.oninput=t=>{n.sunX=parseFloat(t.target.value),a.valSunX&&(a.valSunX.textContent=n.sunX.toFixed(2))},a.preset1.onclick=()=>S({speed:1,branchChance:.035,branchAngle:22,wiggle:.05,gravity:0,phototropismStrength:.015,sunX:.5,initialWidth:8,taper:.94,segmentLength:4,collisionGraceSteps:2,stopOnCollision:!1,leafLength:12,leafWidth:5,trunkColor:"#8b5a3c",maxTipAge:200,maxActiveTips:200}),a.preset2.onclick=()=>S({speed:1,branchChance:.065,branchAngle:22,wiggle:.27,gravity:0,phototropismStrength:.015,sunX:.5,initialWidth:5,taper:.81,segmentLength:4,collisionGraceSteps:5,stopOnCollision:!1,leafLength:10,leafWidth:4,trunkColor:"#6b4423",maxTipAge:170,maxActiveTips:75}),a.preset3.onclick=()=>S({speed:1,branchChance:.055,branchAngle:22,wiggle:.06,gravity:0,phototropismStrength:.015,sunX:.5,initialWidth:16,taper:.9,segmentLength:4,collisionGraceSteps:5,stopOnCollision:!1,leafLength:14,leafWidth:6,trunkColor:"#573312ff",maxTipAge:40,maxActiveTips:75}),a.preset4.onclick=()=>S({speed:1,branchChance:.015,branchAngle:90,wiggle:.01,gravity:0,phototropismStrength:0,sunX:.5,initialWidth:5,taper:1,segmentLength:5,collisionGraceSteps:3,stopOnCollision:!0,leafLength:1,leafWidth:1,trunkColor:"#5d4037",maxTipAge:1e3,maxActiveTips:200}),a.leafSize.value=n.leafLength,a.valLeafSize.textContent=n.leafLength,a.leafSize.oninput=t=>{n.leafLength=parseInt(t.target.value),a.valLeafSize&&(a.valLeafSize.textContent=n.leafLength)},a.leafWidth.value=n.leafWidth,a.valLeafWidth.textContent=n.leafWidth,a.leafWidth.oninput=t=>{n.leafWidth=parseInt(t.target.value),a.valLeafWidth&&(a.valLeafWidth.textContent=n.leafWidth)},a.leafColor.value=n.leafColor,a.valLeafColor.textContent=n.leafColor,a.leafColor.oninput=t=>{n.leafColor=t.target.value,a.valLeafColor&&(a.valLeafColor.textContent=n.leafColor)},a.trunkColor.value=n.trunkColor,a.valTrunkColor.textContent=n.trunkColor,a.trunkColor.oninput=t=>{n.trunkColor=t.target.value,a.valTrunkColor&&(a.valTrunkColor.textContent=n.trunkColor)},a.maxTipAge.value=n.maxTipAge,a.valMaxTipAge.textContent=n.maxTipAge,a.maxTipAge.oninput=t=>{n.maxTipAge=parseInt(t.target.value),a.valMaxTipAge&&(a.valMaxTipAge.textContent=n.maxTipAge)},a.maxActiveTips.value=n.maxActiveTips,a.valMaxActiveTips.textContent=n.maxActiveTips,a.maxActiveTips.oninput=t=>{n.maxActiveTips=parseInt(t.target.value),a.valMaxActiveTips&&(a.valMaxActiveTips.textContent=n.maxActiveTips)},a.btnCreateLeaves.onclick=()=>{b(),i||C()},a.btnClearLeaves.onclick=()=>{!function(){for(let t=0;t<l.length;t++)l[t].leaf=null}(),i||C()},a.btnStart.onclick=()=>{i=!i,i?(a.btnStart.textContent="⏹",a.btnStart.title="Stop",a.btnStart.style.backgroundColor="#4ade80",a.btnStart.style.color="#003300"):(a.btnStart.textContent="▶",a.btnStart.title="Play",a.btnStart.style.backgroundColor="#fbbf24",a.btnStart.style.color="#000")},a.btnReset.onclick=()=>{const t=Math.floor(2147483647*Math.random());a.seedInput.value=t,u(t),f(),i||C()},a.regenerateBtn.onclick=()=>{if(null!==n.seed)u(n.seed);else if(null!==c)u(c),a.seedInput.value=c;else{const t=Math.floor(2147483647*Math.random());a.seedInput.value=t,u(t)}f(),i||C()},window.addEventListener("resize",v),v(),u(null),f(),a.btnStart.textContent="⏹",a.btnStart.title="Stop",a.btnStart.style.backgroundColor="#4ade80",a.btnStart.style.color="#003300",a.btnReset.textContent="Generate new",function e(){i&&(!function(){if(i){for(s+=n.speed;s>=1&&(s-=1,0!==o.length);){let e=[];const a=n.segmentLength,i=n.wiggle,r=n.gravity,s=(n.branchChance,n.branchAngle*Math.PI/180),c=(n.taper,.999),u=n.minWidth,v=!!n.stopOnCollision,f=(n.collisionGraceSteps,t.width),C=t.height;for(let t=0;t<o.length;t++){const x=o[t];if(x.width<u||x.x<0||x.x>f||x.y<0||x.y>C)continue;const y=(p()-.5)*i,I=p(),S=r;let b=x.angle+y+S;const T=n.phototropismStrength||0;if(T>0){const t=("number"==typeof n.sunX?n.sunX:.5)*f,e=n.sunY||0,a=Math.atan2(e-x.y,t-x.x),l=Math.min(1,x.y/C);b+=T*d(a-b)*l}const A=x.x+Math.cos(b)*a,L=x.y+Math.sin(b)*a;if(x.age++,x.age>=n.maxTipAge)continue;const M=n.collisionGraceSteps||0;if(v&&x.age>=M&&m(A,L,x.parentIndex))continue;const B=l.length;if(l.push(new g(A,L,b,x.width,x.parentIndex)),I<n.branchChance){const t=s;e.push(new h(A,L,b-t,x.width*n.taper,B,0)),e.push(new h(A,L,b+t,x.width*n.taper,B,0))}else e.push(new h(A,L,b,x.width*c,B,x.age))}e.length>n.maxActiveTips&&(e.sort((t,e)=>{if(e.age!==t.age)return e.age-t.age;const n=e.x-t.x;return Math.abs(n)>.001?n:e.y-t.y}),e=e.slice(e.length-n.maxActiveTips)),o=e}y()}}(),C()),r=requestAnimationFrame(e)}()}();