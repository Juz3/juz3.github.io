!function(){const t=document.getElementById("simCanvas"),e=t.getContext("2d"),n={speed:1,branchChance:.035,branchAngle:22,wiggle:.08,gravity:0,phototropismStrength:.015,sunX:.5,sunY:20,isSunVisible:!0,taper:.83,initialWidth:28,minWidth:.5,segmentLength:5,seed:null,stopOnCollision:!1,collisionGraceSteps:3,startX:null,startY:null,startAngle:null,leafLength:30,leafWidth:15,leafColor:"#64c864",leafAngleVariance:.4,trunkColor:"#372514ff",maxTipAge:150,maxActiveTips:175},l={speed:document.getElementById("speed"),chance:document.getElementById("chance"),angle:document.getElementById("angle"),wiggle:document.getElementById("wiggle"),initialWidth:document.getElementById("initial-width"),gravity:document.getElementById("gravity"),taper:document.getElementById("taper"),segmentLength:document.getElementById("segment-length"),seedInput:document.getElementById("seed"),seedLabel:document.getElementById("seed-label"),seedBtn:document.getElementById("seed-btn"),regenerateBtn:document.getElementById("btn-regenerate"),stopOnCollision:document.getElementById("stop-on-collision"),valStopCollision:document.getElementById("val-stop-collision"),btnStart:document.getElementById("btn-start"),btnReset:document.getElementById("btn-reset"),valSpeed:document.getElementById("val-speed"),valChance:document.getElementById("val-chance"),valAngle:document.getElementById("val-angle"),valWiggle:document.getElementById("val-wiggle"),valInitialWidth:document.getElementById("val-initial-width"),valGravity:document.getElementById("val-gravity"),phototropism:document.getElementById("phototropism"),valPhototropism:document.getElementById("val-phototropism"),sunX:document.getElementById("sun-x"),valSunX:document.getElementById("val-sun-x"),valTaper:document.getElementById("val-taper"),valSegmentLength:document.getElementById("val-segment-length"),collisionGrace:document.getElementById("collision-grace"),valCollisionGrace:document.getElementById("val-collision-grace"),btnCreateLeaves:document.getElementById("btn-create-leaves"),btnClearLeaves:document.getElementById("btn-clear-leaves"),leafSize:document.getElementById("leaf-size"),valLeafSize:document.getElementById("val-leaf-size"),leafWidth:document.getElementById("leaf-width"),valLeafWidth:document.getElementById("val-leaf-width"),leafColor:document.getElementById("leaf-color"),valLeafColor:document.getElementById("val-leaf-color"),statSegments:document.getElementById("segment-count"),statTips:document.getElementById("tip-count"),statLeaves:document.getElementById("leaf-count"),trunkColor:document.getElementById("trunk-color"),valTrunkColor:document.getElementById("val-trunk-color"),maxTipAge:document.getElementById("max-tip-age"),valMaxTipAge:document.getElementById("val-max-tip-age"),maxActiveTips:document.getElementById("max-active-tips"),valMaxActiveTips:document.getElementById("val-max-active-tips"),preset1:document.getElementById("preset-1"),preset2:document.getElementById("preset-2"),preset3:document.getElementById("preset-3"),preset4:document.getElementById("preset-4")};let a=[],o=[],i=!0,r=null,s=0,c=null;class g{constructor(t,e,n,l,a){this.x=t,this.y=e,this.angle=n,this.width=l,this.parentIndex=a,this.drawn=!1,this.leaf=null}}class h{constructor(t,e,n,l,a,o=0){this.x=t,this.y=e,this.angle=n,this.width=l,this.parentIndex=a,this.age=o}}function u(t){for(;t<=-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;return t}let d=Math.random;function p(t){if(null===t||""===t)n.seed=null,d=Math.random,l.seedLabel&&(l.seedLabel.textContent="—");else{const e=Number(t)||0;n.seed=e,d=function(t){let e=t>>>0;return function(){e+=1831565813;let t=Math.imul(e^e>>>15,1|e);return t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}(e),c=e,l.seedLabel&&(l.seedLabel.textContent=String(e))}}function m(n,l,o=-1){if(!a||0===a.length)return!1;const i=Math.floor(n),r=Math.floor(l);if(i<0||r<0||i>=t.width||r>=t.height)return!1;let s=-1,c=-1,g=-1;if(o>=0&&(s=o,a[o]&&a[o].parentIndex>=0)){c=a[o].parentIndex;const t=a[c]&&a[c].parentIndex;"number"==typeof t&&t>=0&&(g=t)}try{const t=e.getImageData(i,r,1,1).data,h=t[0],u=t[1],d=t[2];if(0!==t[3]&&(26!==h||26!==u||26!==d)){let t=-1,e=Number.POSITIVE_INFINITY,i=null;for(let o=0;o<a.length;o++){if(o===s||o===c||o===g)continue;const r=a[o];if(-1===r.parentIndex)continue;const h=a[r.parentIndex],u=r.x-h.x,d=r.y-h.y,p=u*u+d*d;if(p<=0)continue;let m=((n-h.x)*u+(l-h.y)*d)/p;m=Math.max(0,Math.min(1,m));const v=h.x+m*u,f=h.y+m*d,C=v-n,x=f-l,y=C*C+x*x;y<e&&(e=y,t=o,i=r)}if(i){const n=.6*Math.max(1,i.width/2)+.25;if(e<=(n+.5)*(n+.5)){if(t!==o)return!0}}}}catch(t){}for(let t=0;t<a.length;t++){if(t===s||t===c||t===g)continue;const e=a[t];if(-1===e.parentIndex)continue;const o=a[e.parentIndex],i=o.x,r=o.y,h=e.x-i,u=e.y-r,d=h*h+u*u;let p=0;d>0&&(p=((n-i)*h+(l-r)*u)/d,p=Math.max(0,Math.min(1,p)));const m=i+p*h-n,v=r+p*u-l,f=m*m+v*v,C=Math.max(1,e.width/2);if(f<=(C+1)*(C+1))return!0}return!1}function v(){t.width=window.innerWidth,t.height=window.innerHeight,!i&&a.length>0&&C()}function f(){if(null===n.seed&&null===c){const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,p(t)}else null===n.seed&&null!==c?p(c):null!==n.seed&&p(n.seed);a=[],o=[],s=0;const i=null!==n.startX?n.startX:t.width/2,r=null!==n.startY?n.startY:t.height,g=null!==n.startAngle?n.startAngle:-Math.PI/2;o.push(new h(i,r,g,n.initialWidth,-1)),e.fillStyle="#1a1a1a",e.fillRect(0,0,t.width,t.height),S()}function C(){e.fillStyle="#1a1a1a",e.fillRect(0,0,t.width,t.height),e.lineCap="round",e.lineJoin="round";const{h:l,s:o}=function(t){let e,n,l;3===(t=t.replace(/^#/,"")).length?(e=parseInt(t[0]+t[0],16)/255,n=parseInt(t[1]+t[1],16)/255,l=parseInt(t[2]+t[2],16)/255):(e=parseInt(t.substring(0,2),16)/255,n=parseInt(t.substring(2,4),16)/255,l=parseInt(t.substring(4,6),16)/255);const a=Math.max(e,n,l),o=Math.min(e,n,l),i=a-o;let r=0,s=0,c=(a+o)/2;return 0!==i&&(s=c>.5?i/(2-a-o):i/(a+o),r=a===e?((n-l)/i+(n<l?6:0))/6:a===n?((l-e)/i+2)/6:((e-n)/i+4)/6),{h:Math.round(360*r),s:Math.round(100*s),l:Math.round(100*c)}}(n.trunkColor);for(let t=0;t<a.length;t++){const n=a[t];if(-1===n.parentIndex)continue;const i=a[n.parentIndex],r=n.width,s=Math.max(30,Math.min(70,70-3*r));if(e.strokeStyle=`hsl(${l}, ${o}%, ${s}%)`,e.lineWidth=r,e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(n.x,n.y),e.stroke(),n.leaf){const t=n.leaf,l=n.angle+(t.angleOffset||0);y(e,n.x,n.y,l,t.length,t.width,t.color)}}n.isSunVisible&&function(t,e,n){const l=12,a=t.createRadialGradient(e,n,.2*l,e,n,l);a.addColorStop(0,"rgba(255,245,120,0.95)"),a.addColorStop(1,"rgba(255,200,30,0.6)"),t.beginPath(),t.fillStyle=a,t.arc(e,n,l,0,2*Math.PI),t.fill(),t.beginPath(),t.fillStyle="rgba(255,235,120,0.06)",t.arc(e,n,l+8,0,2*Math.PI),t.fill(),t.lineWidth=1,t.strokeStyle="rgba(255,255,255,0.15)",t.beginPath(),t.arc(e,n,l,0,2*Math.PI),t.stroke()}(e,n.sunX*t.width,n.sunY)}function x(){i?(!function(){if(i){for(s+=n.speed;s>=1&&(s-=1,0!==o.length);){let e=[];const r=n.segmentLength,s=n.wiggle,c=n.gravity,p=(n.branchChance,n.branchAngle*Math.PI/180),v=(n.taper,.999),f=n.minWidth,C=!!n.stopOnCollision,x=(n.collisionGraceSteps,t.width),y=t.height;for(let t=0;t<o.length;t++){const l=o[t];if(l.width<f||l.x<0||l.x>x||l.y<0||l.y>y)continue;const i=(d()-.5)*s,S=d(),b=c;let I=l.angle+i+b;const A=n.phototropismStrength||0;if(0!==A){const t=("number"==typeof n.sunX?n.sunX:.5)*x,e=null!==n.sunY?n.sunY:0,a=Math.atan2(e-l.y,t-l.x),o=e<y/2?Math.min(1,l.y/y):Math.min(1,(y-l.y)/y);I+=A*u(a-I)*o}const T=l.x+Math.cos(I)*r,M=l.y+Math.sin(I)*r;if(l.age++,l.age>=n.maxTipAge)continue;const L=n.collisionGraceSteps||0;if(C&&l.age>=L&&m(T,M,l.parentIndex))continue;const B=a.length;if(a.push(new g(T,M,I,l.width,l.parentIndex)),S<n.branchChance){const t=p;e.push(new h(T,M,I-t,l.width*n.taper,B,0)),e.push(new h(T,M,I+t,l.width*n.taper,B,0))}else e.push(new h(T,M,I,l.width*v,B,l.age))}e.length>n.maxActiveTips&&(e.sort((t,e)=>{if(e.age!==t.age)return e.age-t.age;const n=e.x-t.x;return Math.abs(n)>.001?n:e.y-t.y}),e=e.slice(e.length-n.maxActiveTips)),o=e,0===o.length&&i&&(i=!1,l.btnStart.textContent="▶",l.btnStart.title="Play",l.btnStart.style.backgroundColor="#fbbf24",l.btnStart.style.color="#000")}S()}}(),C(),r=requestAnimationFrame(x)):r=null}function y(t,e,n,l,a,o,i){const r=e+Math.cos(l)*a,s=n+Math.sin(l)*a,c=(e+r)/2,g=(n+s)/2,h=l-Math.PI/2,u=c+Math.cos(h)*o,d=g+Math.sin(h)*o,p=c+Math.cos(h+Math.PI)*o,m=g+Math.sin(h+Math.PI)*o;t.beginPath(),t.moveTo(e,n),t.quadraticCurveTo(u,d,r,s),t.quadraticCurveTo(p,m,e,n),t.fillStyle=i||"rgba(100,200,100,0.85)",t.fill(),t.strokeStyle="rgba(0,0,0,0.25)",t.lineWidth=Math.max(1,.15*o),t.beginPath(),t.moveTo(e,n),t.lineTo(r,s),t.stroke()}function S(){l.statSegments.textContent=a.length,l.statTips.textContent=o.length,l.statLeaves&&(l.statLeaves.textContent=a.reduce((t,e)=>e.leaf?t+1:t,0))}const b={speed:"speed",branchChance:"chance",branchAngle:"angle",wiggle:"wiggle",gravity:"gravity",phototropismStrength:"phototropism",sunX:"sunX",initialWidth:"initialWidth",taper:"taper",segmentLength:"segmentLength",collisionGraceSteps:"collisionGrace",stopOnCollision:"stopOnCollision",leafLength:"leafSize",leafWidth:"leafWidth",trunkColor:"trunkColor",maxTipAge:"maxTipAge",maxActiveTips:"maxActiveTips"};function I(t){for(const e in t){if(!t.hasOwnProperty(e))continue;n[e]=t[e];const a=b[e]||e;if(l[a])try{l[a].value=t[e]}catch(t){}"speed"===e&&l.valSpeed&&(l.valSpeed.textContent=n.speed),"branchChance"===e&&l.valChance&&(l.valChance.textContent=n.branchChance),"branchAngle"===e&&l.valAngle&&(l.valAngle.textContent=n.branchAngle),"wiggle"===e&&l.valWiggle&&(l.valWiggle.textContent=n.wiggle),"gravity"===e&&l.valGravity&&(l.valGravity.textContent=n.gravity),"phototropismStrength"===e&&l.valPhototropism&&(l.valPhototropism.textContent=n.phototropismStrength.toFixed(3)),"sunX"===e&&l.valSunX&&(l.valSunX.textContent=n.sunX.toFixed(2)),"initialWidth"===e&&l.valInitialWidth&&(l.valInitialWidth.textContent=n.initialWidth),"taper"===e&&l.valTaper&&(l.valTaper.textContent=n.taper),"segmentLength"===e&&l.valSegmentLength&&(l.valSegmentLength.textContent=n.segmentLength),"collisionGraceSteps"===e&&l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps),"stopOnCollision"===e&&l.stopOnCollision&&(l.stopOnCollision.checked=!!n.stopOnCollision),"stopOnCollision"===e&&l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off"),"leafLength"===e&&l.valLeafSize&&(l.valLeafSize.textContent=n.leafLength),"leafWidth"===e&&l.valLeafWidth&&(l.valLeafWidth.textContent=n.leafWidth),"trunkColor"===e&&l.valTrunkColor&&(l.valTrunkColor.textContent=n.trunkColor),"maxTipAge"===e&&l.valMaxTipAge&&(l.valMaxTipAge.textContent=n.maxTipAge),"maxActiveTips"===e&&l.valMaxActiveTips&&(l.valMaxActiveTips.textContent=n.maxActiveTips)}f(),i||(i=!0,l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300",null===r&&x())}function A(){const t=function(){const t=new Array(a.length).fill(!1);for(let e=0;e<a.length;e++){const n=a[e].parentIndex;n>=0&&n<a.length&&(t[n]=!0)}const e=[];for(let n=0;n<a.length;n++)-1!==a[n].parentIndex&&(t[n]||e.push(n));return e}();for(let e of t){const t=a[e],l=n.leafLength+(d()-.5)*n.leafLength*.2,o=Math.max(1,Math.round(n.leafWidth+2*(d()-.5))),i=n.leafColor,r=2*(d()-.5)*n.leafAngleVariance;t.leaf={length:l,width:o,color:i,angleOffset:r}}}l.speed.oninput=t=>{n.speed=parseFloat(t.target.value),l.valSpeed&&(l.valSpeed.textContent=n.speed)},l.chance.oninput=t=>{n.branchChance=parseFloat(t.target.value),l.valChance&&(l.valChance.textContent=n.branchChance)},l.angle.oninput=t=>{n.branchAngle=parseInt(t.target.value),l.valAngle&&(l.valAngle.textContent=n.branchAngle)},l.wiggle.oninput=t=>{n.wiggle=parseFloat(t.target.value),l.valWiggle&&(l.valWiggle.textContent=n.wiggle)},l.initialWidth.oninput=t=>{n.initialWidth=parseInt(t.target.value),l.valInitialWidth&&(l.valInitialWidth.textContent=n.initialWidth)},l.gravity.oninput=t=>{n.gravity=parseFloat(t.target.value),l.valGravity&&(l.valGravity.textContent=n.gravity)},l.taper.oninput=t=>{n.taper=parseFloat(t.target.value),l.valTaper&&(l.valTaper.textContent=n.taper)},l.segmentLength.oninput=t=>{n.segmentLength=parseInt(t.target.value),l.valSegmentLength&&(l.valSegmentLength.textContent=n.segmentLength)},l.seedBtn.onclick=()=>{const t=l.seedInput.value;p(""===t?null:Number(t)),f()},l.stopOnCollision.checked=!!n.stopOnCollision,l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off");const T=t=>{n.stopOnCollision=!!t,l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off")};l.stopOnCollision.addEventListener("input",t=>T(t.target.checked)),l.stopOnCollision.addEventListener("change",t=>T(t.target.checked)),l.collisionGrace.value=n.collisionGraceSteps,l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps),l.collisionGrace.oninput=t=>{n.collisionGraceSteps=parseInt(t.target.value||0),l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps)},l.phototropism.value=n.phototropismStrength,l.valPhototropism&&(l.valPhototropism.textContent=n.phototropismStrength.toFixed(3)),l.phototropism.oninput=t=>{n.phototropismStrength=parseFloat(t.target.value),l.valPhototropism&&(l.valPhototropism.textContent=n.phototropismStrength.toFixed(3))},l.sunX.value=n.sunX,l.valSunX&&(l.valSunX.textContent=n.sunX.toFixed(2)),l.sunX.oninput=t=>{n.sunX=parseFloat(t.target.value),l.valSunX&&(l.valSunX.textContent=n.sunX.toFixed(2))},l.preset1.onclick=()=>I({speed:1,branchChance:.035,branchAngle:22,wiggle:.08,gravity:0,phototropismStrength:.015,sunX:.5,sunY:20,isSunVisible:!0,startX:null,startY:null,startAngle:null,initialWidth:28,taper:.83,segmentLength:5,collisionGraceSteps:3,stopOnCollision:!1,leafLength:30,leafWidth:15,trunkColor:"#372514ff",maxTipAge:150,maxActiveTips:175}),l.preset2.onclick=()=>I({speed:1,branchChance:.065,branchAngle:22,wiggle:.27,gravity:0,phototropismStrength:.015,sunX:.5,sunY:1e4,isSunVisible:!1,startX:null,startY:0,startAngle:Math.PI/2,initialWidth:5,taper:.81,segmentLength:4,collisionGraceSteps:5,stopOnCollision:!1,leafLength:10,leafWidth:4,trunkColor:"#6b4423",maxTipAge:170,maxActiveTips:75}),l.preset3.onclick=()=>I({speed:1,branchChance:.055,branchAngle:22,wiggle:.06,gravity:0,phototropismStrength:.015,sunX:.5,sunY:20,isSunVisible:!0,startX:null,startY:null,startAngle:null,initialWidth:16,taper:.9,segmentLength:4,collisionGraceSteps:5,stopOnCollision:!1,leafLength:14,leafWidth:6,trunkColor:"#573312ff",maxTipAge:40,maxActiveTips:75}),l.preset4.onclick=()=>I({speed:1,branchChance:.015,branchAngle:90,wiggle:.01,gravity:0,phototropismStrength:0,sunX:.5,sunY:20,isSunVisible:!1,startX:null,startY:null,startAngle:null,initialWidth:5,taper:1,segmentLength:5,collisionGraceSteps:3,stopOnCollision:!0,leafLength:1,leafWidth:1,trunkColor:"#5d4037",maxTipAge:1e3,maxActiveTips:200}),l.leafSize.value=n.leafLength,l.valLeafSize.textContent=n.leafLength,l.leafSize.oninput=t=>{n.leafLength=parseInt(t.target.value),l.valLeafSize&&(l.valLeafSize.textContent=n.leafLength)},l.leafWidth.value=n.leafWidth,l.valLeafWidth.textContent=n.leafWidth,l.leafWidth.oninput=t=>{n.leafWidth=parseInt(t.target.value),l.valLeafWidth&&(l.valLeafWidth.textContent=n.leafWidth)},l.leafColor.value=n.leafColor,l.valLeafColor.textContent=n.leafColor,l.leafColor.oninput=t=>{n.leafColor=t.target.value,l.valLeafColor&&(l.valLeafColor.textContent=n.leafColor)},l.trunkColor.value=n.trunkColor,l.valTrunkColor.textContent=n.trunkColor,l.trunkColor.oninput=t=>{n.trunkColor=t.target.value,l.valTrunkColor&&(l.valTrunkColor.textContent=n.trunkColor)},l.maxTipAge.value=n.maxTipAge,l.valMaxTipAge.textContent=n.maxTipAge,l.maxTipAge.oninput=t=>{n.maxTipAge=parseInt(t.target.value),l.valMaxTipAge&&(l.valMaxTipAge.textContent=n.maxTipAge)},l.maxActiveTips.value=n.maxActiveTips,l.valMaxActiveTips.textContent=n.maxActiveTips,l.maxActiveTips.oninput=t=>{n.maxActiveTips=parseInt(t.target.value),l.valMaxActiveTips&&(l.valMaxActiveTips.textContent=n.maxActiveTips)},l.btnCreateLeaves.onclick=()=>{A(),i||C()},l.btnClearLeaves.onclick=()=>{!function(){for(let t=0;t<a.length;t++)a[t].leaf=null}(),i||C()},l.btnStart.onclick=()=>{i=!i,i?(l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300",null===r&&x()):(l.btnStart.textContent="▶",l.btnStart.title="Play",l.btnStart.style.backgroundColor="#fbbf24",l.btnStart.style.color="#000")},l.btnReset.onclick=()=>{const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,p(t),f(),i||(i=!0,l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300",null===r&&x())},l.regenerateBtn.onclick=()=>{if(null!==n.seed)p(n.seed);else if(null!==c)p(c),l.seedInput.value=c;else{const t=Math.floor(2147483647*Math.random());l.seedInput.value=t,p(t)}f(),i||(i=!0,l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300",null===r&&x())},window.addEventListener("resize",v),v(),p(null),f(),l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300",l.btnReset.textContent="Generate new",x()}();