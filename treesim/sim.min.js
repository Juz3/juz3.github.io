!function(){const t=document.getElementById("simCanvas"),e=t.getContext("2d"),n={speed:1,branchChance:.035,branchAngle:22,wiggle:.08,gravity:0,phototropismStrength:.015,sunX:.5,sunY:20,taper:.707,initialWidth:40,minWidth:.5,segmentLength:5,seed:null,stopOnCollision:!1,collisionGraceSteps:3,startX:null,startY:null,startAngle:null,leafLength:30,leafWidth:15,leafColor:"#64c864",leafAngleVariance:.4,backgroundColor:"#0a0e14",trunkColor:"#261910ff",useLightnessGradient:!0,maxTipAge:150,maxActiveTips:175,autoFadeTips:!0,oldTipBranchBoost:0},a={speed:document.getElementById("speed"),chance:document.getElementById("chance"),angle:document.getElementById("angle"),wiggle:document.getElementById("wiggle"),initialWidth:document.getElementById("initial-width"),gravity:document.getElementById("gravity"),taper:document.getElementById("taper"),segmentLength:document.getElementById("segment-length"),seedInput:document.getElementById("seed"),seedLabel:document.getElementById("seed-label"),seedBtn:document.getElementById("seed-btn"),regenerateBtn:document.getElementById("btn-regenerate"),stopOnCollision:document.getElementById("stop-on-collision"),valStopCollision:document.getElementById("val-stop-collision"),btnStart:document.getElementById("btn-start"),btnReset:document.getElementById("btn-grow"),valSpeed:document.getElementById("val-speed"),valChance:document.getElementById("val-chance"),valAngle:document.getElementById("val-angle"),valWiggle:document.getElementById("val-wiggle"),valInitialWidth:document.getElementById("val-initial-width"),valGravity:document.getElementById("val-gravity"),phototropism:document.getElementById("phototropism"),valPhototropism:document.getElementById("val-phototropism"),sunX:document.getElementById("sun-x"),valSunX:document.getElementById("val-sun-x"),valTaper:document.getElementById("val-taper"),valSegmentLength:document.getElementById("val-segment-length"),collisionGrace:document.getElementById("collision-grace"),valCollisionGrace:document.getElementById("val-collision-grace"),statSegments:document.getElementById("segment-count"),statTips:document.getElementById("tip-count"),statLeaves:document.getElementById("leaf-count"),bgColor:document.getElementById("bg-color"),valBgColor:document.getElementById("val-bg-color"),trunkColor:document.getElementById("trunk-color"),valTrunkColor:document.getElementById("val-trunk-color"),lightnessGradient:document.getElementById("lightness-gradient"),valLightnessGradient:document.getElementById("val-lightness-gradient"),maxTipAge:document.getElementById("max-tip-age"),valMaxTipAge:document.getElementById("val-max-tip-age"),maxActiveTips:document.getElementById("max-active-tips"),valMaxActiveTips:document.getElementById("val-max-active-tips"),autoFadeTips:document.getElementById("auto-fade-tips"),valAutoFade:document.getElementById("val-auto-fade"),oldTipBranching:document.getElementById("old-tip-branching"),valOldTipBranching:document.getElementById("val-old-tip-branching"),preset1:document.getElementById("preset-1"),preset2:document.getElementById("preset-2"),preset3:document.getElementById("preset-3"),preset4:document.getElementById("preset-4")};let l=[],o=[],i=!0,s=null,r=0,d=null,g=null,c=null,u=!1;class h{constructor(t,e,n,a,l){this.x=t,this.y=e,this.angle=n,this.width=a,this.parentIndex=l,this.drawn=!1,this.leaf=null}}class p{constructor(t,e,n,a,l,o=0){this.x=t,this.y=e,this.angle=n,this.width=a,this.parentIndex=l,this.age=o}}function m(t){for(;t<=-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;return t}let v=Math.random;function x(t){if(null===t||""===t)n.seed=null,v=Math.random,a.seedLabel&&(a.seedLabel.textContent="—");else{const e=Number(t)||0;n.seed=e,v=function(t){let e=t>>>0;return function(){e+=1831565813;let t=Math.imul(e^e>>>15,1|e);return t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}(e),d=e,a.seedLabel&&(a.seedLabel.textContent=String(e))}}function C(n,a,o=-1){if(!l||0===l.length)return!1;const i=Math.floor(n),s=Math.floor(a);if(i<0||s<0||i>=t.width||s>=t.height)return!1;let r=-1,d=-1,g=-1;if(o>=0&&(r=o,l[o]&&l[o].parentIndex>=0)){d=l[o].parentIndex;const t=l[d]&&l[d].parentIndex;"number"==typeof t&&t>=0&&(g=t)}try{const t=e.getImageData(i,s,1,1).data,c=t[0],u=t[1],h=t[2];if(0!==t[3]&&(26!==c||26!==u||26!==h)){let t=-1,e=Number.POSITIVE_INFINITY,i=null;for(let o=0;o<l.length;o++){if(o===r||o===d||o===g)continue;const s=l[o];if(-1===s.parentIndex)continue;const c=l[s.parentIndex],u=s.x-c.x,h=s.y-c.y,p=u*u+h*h;if(p<=0)continue;let m=((n-c.x)*u+(a-c.y)*h)/p;m=Math.max(0,Math.min(1,m));const v=c.x+m*u,x=c.y+m*h,C=v-n,f=x-a,y=C*C+f*f;y<e&&(e=y,t=o,i=s)}if(i){const n=.6*Math.max(1,i.width/2)+.25;if(e<=(n+.5)*(n+.5)){if(t!==o)return!0}}}}catch(t){}for(let t=0;t<l.length;t++){if(t===r||t===d||t===g)continue;const e=l[t];if(-1===e.parentIndex)continue;const o=l[e.parentIndex],i=o.x,s=o.y,c=e.x-i,u=e.y-s,h=c*c+u*u;let p=0;h>0&&(p=((n-i)*c+(a-s)*u)/h,p=Math.max(0,Math.min(1,p)));const m=i+p*c-n,v=s+p*u-a,x=m*m+v*v,C=Math.max(1,e.width/2);if(x<=(C+1)*(C+1))return!0}return!1}function f(){t.width=window.innerWidth,t.height=window.innerHeight,!i&&l.length>0&&I()}function y(){if(null===n.seed&&null===d){const t=Math.floor(2147483647*Math.random());a.seedInput.value=t,x(t)}else null===n.seed&&null!==d?x(d):null!==n.seed&&x(n.seed);l=[],o=[],r=0,g=n.maxTipAge;const i=null!==n.startX?n.startX:t.width/2,s=null!==n.startY?n.startY:t.height,c=null!==n.startAngle?n.startAngle:-Math.PI/2;o.push(new p(i,s,c,n.initialWidth,-1)),e.fillStyle=n.backgroundColor,e.fillRect(0,0,t.width,t.height),S()}function I(){let a;if(e.fillStyle=n.backgroundColor,e.fillRect(0,0,t.width,t.height),e.lineCap="round",e.lineJoin="round",n.useLightnessGradient){const{h:t,s:e}=function(t){let e,n,a;3===(t=t.replace(/^#/,"")).length?(e=parseInt(t[0]+t[0],16)/255,n=parseInt(t[1]+t[1],16)/255,a=parseInt(t[2]+t[2],16)/255):(e=parseInt(t.substring(0,2),16)/255,n=parseInt(t.substring(2,4),16)/255,a=parseInt(t.substring(4,6),16)/255);const l=Math.max(e,n,a),o=Math.min(e,n,a),i=l-o;let s=0,r=0,d=(l+o)/2;return 0!==i&&(r=d>.5?i/(2-l-o):i/(l+o),s=l===e?((n-a)/i+(n<a?6:0))/6:l===n?((a-e)/i+2)/6:((e-n)/i+4)/6),{h:Math.round(360*s),s:Math.round(100*r),l:Math.round(100*d)}}(n.trunkColor);a={h:t,s:e,useGradient:!0}}else a={color:n.trunkColor,useGradient:!1};for(let t=0;t<l.length;t++){const n=l[t];if(-1===n.parentIndex)continue;const o=l[n.parentIndex],i=n.width;if(a.useGradient){const t=Math.max(30,Math.min(70,70-3*i));e.strokeStyle=`hsl(${a.h}, ${a.s}%, ${t}%)`}else e.strokeStyle=a.color;e.lineWidth=i,e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(n.x,n.y),e.stroke()}u&&function(t,e,n){const a=12,l=t.createRadialGradient(e,n,.2*a,e,n,a);l.addColorStop(0,"rgba(255,245,120,0.95)"),l.addColorStop(1,"rgba(255,200,30,0.6)"),t.beginPath(),t.fillStyle=l,t.arc(e,n,a,0,2*Math.PI),t.fill(),t.beginPath(),t.fillStyle="rgba(255,235,120,0.06)",t.arc(e,n,a+8,0,2*Math.PI),t.fill(),t.lineWidth=1,t.strokeStyle="rgba(255,255,255,0.15)",t.beginPath(),t.arc(e,n,a,0,2*Math.PI),t.stroke()}(e,n.sunX*t.width,n.sunY)}function T(){i?(!function(){if(i){for(r+=n.speed;r>=1&&(r-=1,0!==o.length);){let e=[];const s=n.segmentLength,r=n.wiggle,d=n.gravity,c=n.branchChance,u=n.branchAngle*Math.PI/180,x=n.taper,f=.999,y=n.minWidth,I=!!n.stopOnCollision,T=n.collisionGraceSteps||4,S=t.width,b=t.height;for(let t=0;t<o.length;t++){const a=o[t];if(a.width<y||a.x<0||a.x>S||a.y<0||a.y>b)continue;const i=(v()-.5)*r,B=v(),A=d;let L=a.angle+i+A;const E=n.phototropismStrength||0;if(0!==E){const t=("number"==typeof n.sunX?n.sunX:.5)*S,e=null!==n.sunY?n.sunY:0,l=Math.atan2(e-a.y,t-a.x),o=e<b/2?Math.min(1,a.y/b):Math.min(1,(b-a.y)/b);L+=E*m(l-L)*o}const G=a.x+Math.cos(L)*s,k=a.y+Math.sin(L)*s;a.age++;let w=n.autoFadeTips?g:n.maxTipAge;if(n.autoFadeTips&&a.width<2&&(w*=a.width/2),a.age>=w)continue;if(I&&a.age>=T&&C(G,k,a.parentIndex))continue;const M=l.length;l.push(new h(G,k,L,a.width,a.parentIndex));let F=c;if(n.oldTipBranchBoost>0){const t=w/2;a.age>t&&(F=c*(1+(a.age-t)/t*n.oldTipBranchBoost))}if(B<F){const t=u;e.push(new p(G,k,L-t,a.width*x,M,0)),e.push(new p(G,k,L+t,a.width*x,M,0))}else e.push(new p(G,k,L,a.width*f,M,a.age))}e.length>n.maxActiveTips&&(e.sort((t,e)=>{if(e.age!==t.age)return e.age-t.age;const n=e.x-t.x;return Math.abs(n)>.001?n:e.y-t.y}),e=e.slice(e.length-n.maxActiveTips)),o=e,n.autoFadeTips&&o.length>0&&o.reduce((t,e)=>t+e.width,0)/o.length<2&&g>0&&(g*=.8),0===o.length&&i&&(i=!1,a.btnStart.textContent="▶",a.btnStart.title="Play")}S()}}(),I(),s=requestAnimationFrame(T)):s=null}function S(){a.statSegments.textContent=l.length,a.statTips.textContent=o.length,a.statLeaves&&(a.statLeaves.textContent=l.reduce((t,e)=>e.leaf?t+1:t,0))}const b={speed:"speed",branchChance:"chance",branchAngle:"angle",wiggle:"wiggle",gravity:"gravity",phototropismStrength:"phototropism",sunX:"sunX",initialWidth:"initialWidth",taper:"taper",segmentLength:"segmentLength",collisionGraceSteps:"collisionGrace",stopOnCollision:"stopOnCollision",leafLength:"leafSize",leafWidth:"leafWidth",trunkColor:"trunkColor",maxTipAge:"maxTipAge",maxActiveTips:"maxActiveTips"};function B(t){for(const e in t){if(!t.hasOwnProperty(e))continue;n[e]=t[e];const l=b[e]||e;if(a[l])try{a[l].value=t[e]}catch(t){}"speed"===e&&a.valSpeed&&(a.valSpeed.textContent=n.speed),"branchChance"===e&&a.valChance&&(a.valChance.textContent=n.branchChance),"branchAngle"===e&&a.valAngle&&(a.valAngle.textContent=n.branchAngle),"wiggle"===e&&a.valWiggle&&(a.valWiggle.textContent=n.wiggle),"gravity"===e&&a.valGravity&&(a.valGravity.textContent=n.gravity),"phototropismStrength"===e&&a.valPhototropism&&(a.valPhototropism.textContent=n.phototropismStrength.toFixed(3)),"sunX"===e&&a.valSunX&&(a.valSunX.textContent=n.sunX.toFixed(2)),"initialWidth"===e&&a.valInitialWidth&&(a.valInitialWidth.textContent=n.initialWidth),"taper"===e&&a.valTaper&&(a.valTaper.textContent=n.taper),"segmentLength"===e&&a.valSegmentLength&&(a.valSegmentLength.textContent=n.segmentLength),"collisionGraceSteps"===e&&a.valCollisionGrace&&(a.valCollisionGrace.textContent=n.collisionGraceSteps),"stopOnCollision"===e&&a.stopOnCollision&&(a.stopOnCollision.checked=!!n.stopOnCollision),"stopOnCollision"===e&&a.valStopCollision&&(a.valStopCollision.textContent=n.stopOnCollision?"on":"off"),"leafLength"===e&&a.valLeafSize&&(a.valLeafSize.textContent=n.leafLength),"leafWidth"===e&&a.valLeafWidth&&(a.valLeafWidth.textContent=n.leafWidth),"trunkColor"===e&&a.valTrunkColor&&(a.valTrunkColor.textContent=n.trunkColor),"useLightnessGradient"===e&&a.lightnessGradient&&(a.lightnessGradient.checked=!!n.useLightnessGradient),"useLightnessGradient"===e&&a.valLightnessGradient&&(a.valLightnessGradient.textContent=n.useLightnessGradient?"on":"off"),"maxTipAge"===e&&a.valMaxTipAge&&(a.valMaxTipAge.textContent=n.maxTipAge),"maxActiveTips"===e&&a.valMaxActiveTips&&(a.valMaxActiveTips.textContent=n.maxActiveTips),"autoFadeTips"===e&&a.autoFadeTips&&(a.autoFadeTips.checked=!!n.autoFadeTips),"autoFadeTips"===e&&a.valAutoFade&&(a.valAutoFade.textContent=n.autoFadeTips?"on":"off")}y(),i||(i=!0,a.btnStart.textContent="⏹",a.btnStart.title="Stop",null===s&&T())}a.speed.oninput=t=>{n.speed=parseFloat(t.target.value),a.valSpeed&&(a.valSpeed.textContent=n.speed)},a.chance.oninput=t=>{n.branchChance=parseFloat(t.target.value),a.valChance&&(a.valChance.textContent=n.branchChance)},a.angle.oninput=t=>{n.branchAngle=parseInt(t.target.value),a.valAngle&&(a.valAngle.textContent=n.branchAngle)},a.wiggle.oninput=t=>{n.wiggle=parseFloat(t.target.value),a.valWiggle&&(a.valWiggle.textContent=n.wiggle)},a.initialWidth.oninput=t=>{n.initialWidth=parseInt(t.target.value),a.valInitialWidth&&(a.valInitialWidth.textContent=n.initialWidth)},a.gravity.oninput=t=>{n.gravity=parseFloat(t.target.value),a.valGravity&&(a.valGravity.textContent=n.gravity)},a.taper.oninput=t=>{n.taper=parseFloat(t.target.value),a.valTaper&&(a.valTaper.textContent=n.taper)},a.segmentLength.oninput=t=>{n.segmentLength=parseInt(t.target.value),a.valSegmentLength&&(a.valSegmentLength.textContent=n.segmentLength)},a.seedBtn.onclick=()=>{const t=a.seedInput.value;x(""===t?null:Number(t)),y()},a.stopOnCollision.checked=!!n.stopOnCollision,a.valStopCollision&&(a.valStopCollision.textContent=n.stopOnCollision?"on":"off");const A=t=>{n.stopOnCollision=!!t,a.valStopCollision&&(a.valStopCollision.textContent=n.stopOnCollision?"on":"off")};a.stopOnCollision.addEventListener("input",t=>A(t.target.checked)),a.stopOnCollision.addEventListener("change",t=>A(t.target.checked)),a.autoFadeTips.checked=!!n.autoFadeTips,a.valAutoFade&&(a.valAutoFade.textContent=n.autoFadeTips?"on":"off");const L=t=>{n.autoFadeTips=!!t,a.valAutoFade&&(a.valAutoFade.textContent=n.autoFadeTips?"on":"off")};a.autoFadeTips.addEventListener("input",t=>L(t.target.checked)),a.autoFadeTips.addEventListener("change",t=>L(t.target.checked)),a.oldTipBranching.value=n.oldTipBranchBoost,a.valOldTipBranching&&(a.valOldTipBranching.textContent=n.oldTipBranchBoost),a.oldTipBranching.oninput=t=>{n.oldTipBranchBoost=parseFloat(t.target.value),a.valOldTipBranching&&(a.valOldTipBranching.textContent=n.oldTipBranchBoost)},a.collisionGrace.value=n.collisionGraceSteps,a.valCollisionGrace&&(a.valCollisionGrace.textContent=n.collisionGraceSteps),a.collisionGrace.oninput=t=>{n.collisionGraceSteps=parseInt(t.target.value||0),a.valCollisionGrace&&(a.valCollisionGrace.textContent=n.collisionGraceSteps)},a.phototropism.value=n.phototropismStrength,a.valPhototropism&&(a.valPhototropism.textContent=n.phototropismStrength.toFixed(3)),a.phototropism.oninput=t=>{n.phototropismStrength=parseFloat(t.target.value),a.valPhototropism&&(a.valPhototropism.textContent=n.phototropismStrength.toFixed(3))},a.sunX.value=n.sunX,a.valSunX&&(a.valSunX.textContent=n.sunX.toFixed(2)),a.sunX.oninput=t=>{n.sunX=parseFloat(t.target.value),a.valSunX&&(a.valSunX.textContent=n.sunX.toFixed(2)),u=!0,i||I(),c&&clearTimeout(c),c=setTimeout(()=>{u=!1,i||I(),c=null},1e3)},a.preset1.onclick=()=>B({speed:1,branchChance:.035,branchAngle:22,wiggle:.08,gravity:0,phototropismStrength:.015,sunX:.5,sunY:20,startX:null,startY:null,startAngle:null,initialWidth:40,taper:.707,segmentLength:5,collisionGraceSteps:3,stopOnCollision:!1,leafLength:30,leafWidth:15,trunkColor:"#211b11ff",useLightnessGradient:!0,maxTipAge:150,maxActiveTips:175,autoFadeTips:!0}),a.preset2.onclick=()=>B({speed:1,branchChance:.065,branchAngle:22,wiggle:.27,gravity:0,phototropismStrength:.015,sunX:.5,sunY:1e4,startX:null,startY:0,startAngle:Math.PI/2,initialWidth:5,taper:.81,segmentLength:4,collisionGraceSteps:5,stopOnCollision:!1,leafLength:10,leafWidth:4,trunkColor:"#6b4423",useLightnessGradient:!0,maxTipAge:170,maxActiveTips:75,autoFadeTips:!1}),a.preset3.onclick=()=>B({speed:1,branchChance:.055,branchAngle:22,wiggle:.06,gravity:0,phototropismStrength:.015,sunX:.5,sunY:20,startX:null,startY:null,startAngle:null,initialWidth:16,taper:.9,segmentLength:4,collisionGraceSteps:5,stopOnCollision:!1,leafLength:14,leafWidth:6,trunkColor:"#30460aff",useLightnessGradient:!0,maxTipAge:40,maxActiveTips:75,autoFadeTips:!0}),a.preset4.onclick=()=>B({speed:1,branchChance:.015,branchAngle:90,wiggle:.01,gravity:0,phototropismStrength:0,sunX:.5,sunY:20,startX:null,startY:null,startAngle:null,initialWidth:5,taper:1,segmentLength:5,collisionGraceSteps:3,stopOnCollision:!0,leafLength:1,leafWidth:1,trunkColor:"#9eb1c6ff",useLightnessGradient:!1,maxTipAge:1e3,maxActiveTips:200,autoFadeTips:!1}),a.bgColor.value=n.backgroundColor,a.valBgColor.textContent=n.backgroundColor,a.bgColor.oninput=t=>{n.backgroundColor=t.target.value,a.valBgColor&&(a.valBgColor.textContent=n.backgroundColor)},a.trunkColor.value=n.trunkColor,a.valTrunkColor.textContent=n.trunkColor,a.trunkColor.oninput=t=>{n.trunkColor=t.target.value,a.valTrunkColor&&(a.valTrunkColor.textContent=n.trunkColor)},a.lightnessGradient.checked=!!n.useLightnessGradient,a.valLightnessGradient&&(a.valLightnessGradient.textContent=n.useLightnessGradient?"on":"off");const E=t=>{n.useLightnessGradient=!!t,a.valLightnessGradient&&(a.valLightnessGradient.textContent=n.useLightnessGradient?"on":"off")};a.lightnessGradient.addEventListener("input",t=>E(t.target.checked)),a.lightnessGradient.addEventListener("change",t=>E(t.target.checked)),a.maxTipAge.value=n.maxTipAge,a.valMaxTipAge.textContent=n.maxTipAge,a.maxTipAge.oninput=t=>{n.maxTipAge=parseInt(t.target.value),a.valMaxTipAge&&(a.valMaxTipAge.textContent=n.maxTipAge)},a.maxActiveTips.value=n.maxActiveTips,a.valMaxActiveTips.textContent=n.maxActiveTips,a.maxActiveTips.oninput=t=>{n.maxActiveTips=parseInt(t.target.value),a.valMaxActiveTips&&(a.valMaxActiveTips.textContent=n.maxActiveTips)},a.btnStart.onclick=()=>{i=!i,i?(a.btnStart.textContent="⏹",a.btnStart.title="Stop",null===s&&T()):(a.btnStart.textContent="▶",a.btnStart.title="Play")},a.btnReset.onclick=()=>{const t=Math.floor(2147483647*Math.random());a.seedInput.value=t,x(t),y(),i||(i=!0,a.btnStart.textContent="⏹",a.btnStart.title="Stop",null===s&&T())},a.regenerateBtn.onclick=()=>{if(null!==n.seed)x(n.seed);else if(null!==d)x(d),a.seedInput.value=d;else{const t=Math.floor(2147483647*Math.random());a.seedInput.value=t,x(t)}y(),i||(i=!0,a.btnStart.textContent="⏹",a.btnStart.title="Stop",null===s&&T())},window.addEventListener("resize",f),f(),x(null),y(),a.btnStart.textContent="⏹",a.btnStart.title="Stop",a.btnReset.textContent="Grow new";const G=document.getElementById("toggle-advanced"),k=document.getElementById("advanced-controls"),w=document.getElementById("advanced-arrow");G&&k&&w&&(G.onclick=()=>{const t="none"===k.style.display;k.style.display=t?"block":"none",w.style.transform=t?"rotate(180deg)":"rotate(0deg)"}),T()}();