!function(){const e=document.getElementById("simCanvas"),t=e.getContext("2d"),n={speed:.5,branchChance:.02,branchAngle:18,wiggle:.1,gravity:0,taper:.95,initialWidth:12,minWidth:.5,segmentLength:5,seed:null,stopOnCollision:!1,collisionGraceSteps:3,leafLength:20,leafWidth:8,leafColor:"#64c864",leafAngleVariance:.4},l={speed:document.getElementById("speed"),chance:document.getElementById("chance"),angle:document.getElementById("angle"),wiggle:document.getElementById("wiggle"),gravity:document.getElementById("gravity"),taper:document.getElementById("taper"),segmentLength:document.getElementById("segment-length"),seedInput:document.getElementById("seed"),seedLabel:document.getElementById("seed-label"),seedBtn:document.getElementById("seed-btn"),regenerateBtn:document.getElementById("btn-regenerate"),stopOnCollision:document.getElementById("stop-on-collision"),valStopCollision:document.getElementById("val-stop-collision"),btnStart:document.getElementById("btn-start"),btnReset:document.getElementById("btn-reset"),valSpeed:document.getElementById("val-speed"),valChance:document.getElementById("val-chance"),valAngle:document.getElementById("val-angle"),valWiggle:document.getElementById("val-wiggle"),valGravity:document.getElementById("val-gravity"),valTaper:document.getElementById("val-taper"),valSegmentLength:document.getElementById("val-segment-length"),collisionGrace:document.getElementById("collision-grace"),valCollisionGrace:document.getElementById("val-collision-grace"),btnCreateLeaves:document.getElementById("btn-create-leaves"),btnClearLeaves:document.getElementById("btn-clear-leaves"),leafSize:document.getElementById("leaf-size"),valLeafSize:document.getElementById("val-leaf-size"),leafWidth:document.getElementById("leaf-width"),valLeafWidth:document.getElementById("val-leaf-width"),leafColor:document.getElementById("leaf-color"),valLeafColor:document.getElementById("val-leaf-color"),leafOnlyThin:document.getElementById("leaf-only-thin"),leafMaxWidth:document.getElementById("leaf-max-width"),valLeafMaxWidth:document.getElementById("val-leaf-max-width"),statSegments:document.getElementById("segment-count"),statTips:document.getElementById("tip-count"),statLeaves:document.getElementById("leaf-count")};let a=[],o=[],i=!0,s=null,r=0,d=null;class c{constructor(e,t,n,l,a){this.x=e,this.y=t,this.angle=n,this.width=l,this.parentIndex=a,this.drawn=!1,this.leaf=null}}class h{constructor(e,t,n,l,a,o=0){this.x=e,this.y=t,this.angle=n,this.width=l,this.parentIndex=a,this.age=o}}let g=Math.random;function u(e){if(null===e||""===e)n.seed=null,g=Math.random,l.seedLabel&&(l.seedLabel.textContent="—");else{const t=Number(e)||0;n.seed=t,g=function(e){let t=e>>>0;return function(){t+=1831565813;let e=Math.imul(t^t>>>15,1|t);return e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}(t),d=t,l.seedLabel&&(l.seedLabel.textContent=String(t))}}function f(n,l,o=-1){if(!a||0===a.length)return!1;const i=Math.floor(n),s=Math.floor(l);if(i<0||s<0||i>=e.width||s>=e.height)return!1;let r=-1,d=-1,c=-1;if(o>=0&&(r=o,a[o]&&a[o].parentIndex>=0)){d=a[o].parentIndex;const e=a[d]&&a[d].parentIndex;"number"==typeof e&&e>=0&&(c=e)}try{const e=t.getImageData(i,s,1,1).data,h=e[0],g=e[1],u=e[2];if(0!==e[3]&&(26!==h||26!==g||26!==u)){let e=-1,t=Number.POSITIVE_INFINITY,i=null;for(let o=0;o<a.length;o++){if(o===r||o===d||o===c)continue;const s=a[o];if(-1===s.parentIndex)continue;const h=a[s.parentIndex],g=s.x-h.x,u=s.y-h.y,f=g*g+u*u;if(f<=0)continue;let m=((n-h.x)*g+(l-h.y)*u)/f;m=Math.max(0,Math.min(1,m));const v=h.x+m*g,p=h.y+m*u,C=v-n,x=p-l,y=C*C+x*x;y<t&&(t=y,e=o,i=s)}if(i){const n=.6*Math.max(1,i.width/2)+.25;if(t<=(n+.5)*(n+.5)){if(e!==o)return!0}}}}catch(e){}for(let e=0;e<a.length;e++){if(e===r||e===d||e===c)continue;const t=a[e];if(-1===t.parentIndex)continue;const o=a[t.parentIndex],i=o.x,s=o.y,h=t.x-i,g=t.y-s,u=h*h+g*g;let f=0;u>0&&(f=((n-i)*h+(l-s)*g)/u,f=Math.max(0,Math.min(1,f)));const m=i+f*h-n,v=s+f*g-l,p=m*m+v*v,C=Math.max(1,t.width/2);if(p<=(C+1)*(C+1))return!0}return!1}function m(){e.width=window.innerWidth,e.height=window.innerHeight,!i&&a.length>0&&p()}function v(){if(null===n.seed&&null===d){const e=Math.floor(2147483647*Math.random());l.seedInput.value=e,u(e)}else null===n.seed&&null!==d?u(d):null!==n.seed&&u(n.seed);a=[],o=[],r=0;const i=e.width/2,s=e.height;o.push(new h(i,s,-Math.PI/2,n.initialWidth,-1)),t.fillStyle="#1a1a1a",t.fillRect(0,0,e.width,e.height),x()}function p(){t.fillStyle="#1a1a1a",t.fillRect(0,0,e.width,e.height),t.lineCap="round",t.lineJoin="round";for(let e=0;e<a.length;e++){const n=a[e];if(-1===n.parentIndex)continue;const l=a[n.parentIndex],o=n.width,i=Math.max(30,Math.min(70,70-3*o));if(t.strokeStyle=`hsl(32, 60%, ${i}%)`,t.lineWidth=o,t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(n.x,n.y),t.stroke(),n.leaf){const e=n.leaf,l=n.angle+(e.angleOffset||0);C(t,n.x,n.y,l,e.length,e.width,e.color)}}}function C(e,t,n,l,a,o,i){const s=t+Math.cos(l)*a,r=n+Math.sin(l)*a,d=(t+s)/2,c=(n+r)/2,h=l-Math.PI/2,g=d+Math.cos(h)*o,u=c+Math.sin(h)*o,f=d+Math.cos(h+Math.PI)*o,m=c+Math.sin(h+Math.PI)*o;e.beginPath(),e.moveTo(t,n),e.quadraticCurveTo(g,u,s,r),e.quadraticCurveTo(f,m,t,n),e.fillStyle=i||"rgba(100,200,100,0.85)",e.fill(),e.strokeStyle="rgba(0,0,0,0.25)",e.lineWidth=Math.max(1,.15*o),e.beginPath(),e.moveTo(t,n),e.lineTo(s,r),e.stroke()}function x(){l.statSegments.textContent=a.length,l.statTips.textContent=o.length,l.statLeaves&&(l.statLeaves.textContent=a.reduce((e,t)=>t.leaf?e+1:e,0))}function y(){const e=function(){const e=new Array(a.length).fill(!1);for(let t=0;t<a.length;t++){const n=a[t].parentIndex;n>=0&&n<a.length&&(e[n]=!0)}const t=[];for(let n=0;n<a.length;n++)-1!==a[n].parentIndex&&(e[n]||t.push(n));return t}();for(let t of e){const e=a[t];if(n.leafOnlyThinBranches&&e.width>n.leafMaxBranchWidth)continue;const l=n.leafLength+(g()-.5)*n.leafLength*.2,o=Math.max(1,Math.round(n.leafWidth+2*(g()-.5))),i=n.leafColor,s=2*(g()-.5)*n.leafAngleVariance;e.leaf={length:l,width:o,color:i,angleOffset:s}}}if(l.speed.oninput=e=>{n.speed=parseFloat(e.target.value),l.valSpeed.textContent=n.speed},l.chance.oninput=e=>{n.branchChance=parseFloat(e.target.value),l.valChance.textContent=n.branchChance},l.angle.oninput=e=>{n.branchAngle=parseInt(e.target.value),l.valAngle.textContent=n.branchAngle},l.wiggle.oninput=e=>{n.wiggle=parseFloat(e.target.value),l.valWiggle.textContent=n.wiggle},l.gravity.oninput=e=>{n.gravity=parseFloat(e.target.value),l.valGravity.textContent=n.gravity},l.taper.oninput=e=>{n.taper=parseFloat(e.target.value),l.valTaper.textContent=n.taper},l.segmentLength.oninput=e=>{n.segmentLength=parseInt(e.target.value),l.valSegmentLength.textContent=n.segmentLength},l.seedBtn.onclick=()=>{const e=l.seedInput.value;u(""===e?null:Number(e)),v()},l.stopOnCollision){l.stopOnCollision.checked=!!n.stopOnCollision,l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off");const e=e=>{n.stopOnCollision=!!e,l.valStopCollision&&(l.valStopCollision.textContent=n.stopOnCollision?"on":"off")};l.stopOnCollision.addEventListener("input",t=>e(t.target.checked)),l.stopOnCollision.addEventListener("change",t=>e(t.target.checked))}l.collisionGrace&&(l.collisionGrace.value=n.collisionGraceSteps,l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps),l.collisionGrace.oninput=e=>{n.collisionGraceSteps=parseInt(e.target.value||0),l.valCollisionGrace&&(l.valCollisionGrace.textContent=n.collisionGraceSteps)}),l.leafSize&&(l.leafSize.value=n.leafLength,l.valLeafSize&&(l.valLeafSize.textContent=n.leafLength),l.leafSize.oninput=e=>{n.leafLength=parseInt(e.target.value),l.valLeafSize&&(l.valLeafSize.textContent=n.leafLength)}),l.leafWidth&&(l.leafWidth.value=n.leafWidth,l.valLeafWidth&&(l.valLeafWidth.textContent=n.leafWidth),l.leafWidth.oninput=e=>{n.leafWidth=parseInt(e.target.value),l.valLeafWidth&&(l.valLeafWidth.textContent=n.leafWidth)}),l.leafColor&&(l.leafColor.value=n.leafColor,l.valLeafColor&&(l.valLeafColor.textContent=n.leafColor),l.leafColor.oninput=e=>{n.leafColor=e.target.value,l.valLeafColor&&(l.valLeafColor.textContent=n.leafColor)}),l.leafMaxWidth&&(l.leafMaxWidth.value=n.leafMaxBranchWidth,l.valLeafMaxWidth&&(l.valLeafMaxWidth.textContent=n.leafMaxBranchWidth),l.leafMaxWidth.oninput=e=>{n.leafMaxBranchWidth=parseInt(e.target.value),l.valLeafMaxWidth&&(l.valLeafMaxWidth.textContent=n.leafMaxBranchWidth)}),l.btnCreateLeaves&&(l.btnCreateLeaves.onclick=()=>{y(),i||p()}),l.btnClearLeaves&&(l.btnClearLeaves.onclick=()=>{!function(){for(let e=0;e<a.length;e++)a[e].leaf=null}(),i||p()}),l.btnStart.onclick=()=>{i=!i,i?(l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300"):(l.btnStart.textContent="▶",l.btnStart.title="Play",l.btnStart.style.backgroundColor="#fbbf24",l.btnStart.style.color="#000")},l.btnReset.onclick=()=>{const e=Math.floor(2147483647*Math.random());l.seedInput.value=e,u(e),v(),i||p()},l.regenerateBtn.onclick=()=>{if(null!==n.seed)u(n.seed);else if(null!==d)u(d),l.seedInput.value=d;else{const e=Math.floor(2147483647*Math.random());l.seedInput.value=e,u(e)}v(),i||p()},window.addEventListener("resize",m),m(),u(null),v(),l.btnStart&&(l.btnStart.textContent="⏹",l.btnStart.title="Stop",l.btnStart.style.backgroundColor="#4ade80",l.btnStart.style.color="#003300"),l.btnReset&&(l.btnReset.textContent="Generate new"),function t(){i&&(!function(){if(i){for(r+=n.speed;r>=1&&(r-=1,0!==o.length);){let t=[];const l=n.segmentLength,i=n.wiggle,s=n.gravity,r=(n.branchChance,n.branchAngle*Math.PI/180),d=(n.taper,.999),u=n.minWidth,m=!!n.stopOnCollision,v=(n.collisionGraceSteps,e.width),p=e.height;for(let e=0;e<o.length;e++){const C=o[e];if(C.width<u||C.x<-50||C.x>v+50||C.y<-50||C.y>p+50)continue;const x=(g()-.5)*i,y=g(),I=s;let b=C.angle+x+I;const L=C.x+Math.cos(b)*l,S=C.y+Math.sin(b)*l;C.age++;const M=n.collisionGraceSteps||0;if(m&&C.age>=M&&f(L,S,C.parentIndex))continue;const B=a.length;if(a.push(new c(L,S,b,C.width,C.parentIndex)),y<n.branchChance){const e=r;t.push(new h(L,S,b-e,C.width*n.taper,B,0)),t.push(new h(L,S,b+e,C.width*n.taper,B,0))}else t.push(new h(L,S,b,C.width*d,B,C.age))}o=t}x()}}(),p()),s=requestAnimationFrame(t)}()}();